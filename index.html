<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŸºäºDeepSeekçš„AIè‚¡ç¥¨åˆ†æ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        /* CSSå˜é‡ - é»˜è®¤æµ…è‰²æ¨¡å¼ */
        :root {
            --bg-color: #ffffff;
            --text-color: #1f2328;
            --card-bg: #f6f8fa;
            --border-color: #d1d9e0;
            --input-bg: #ffffff;
            --hover-bg: #f3f4f6;
            --gray-400: #656d76;
            --gray-500: #8b949e;
            --primary-color: #238636;
            --primary-hover: #2ea043;
            --blue-400: #0969da;
            --red-400: #cf222e;
            --green-400: #1a7f37;
        }
        
        /* æ·±è‰²æ¨¡å¼å˜é‡ */
        body[data-theme="dark"] {
            --bg-color: #0d1117;
            --text-color: #c9d1d9;
            --card-bg: #161b22;
            --border-color: #30363d;
            --input-bg: #0d1117;
            --hover-bg: #21262d;
            --gray-400: #8b949e;
            --gray-500: #6e7681;
            --primary-color: #238636;
            --primary-hover: #2ea043;
            --blue-400: #58a6ff;
            --red-400: #f85149;
            --green-400: #7ee787;
        }
        
        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: all 0.3s ease;
            padding: 1rem;
        }
        
        @media (min-width: 768px) {
            body {
                padding: 1.5rem;
            }
        }
        
        .card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            transition: all 0.3s ease;
        }
        
        .card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        
        .btn-primary {
            background: var(--primary-color);
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            background: var(--primary-hover);
            transform: translateY(-1px);
        }
        
        .stream-box {
            line-height: 1.8;
            font-family: "PingFang SC", "Microsoft YaHei", sans-serif;
        }
        
        .stream-box p {
            margin-bottom: 1.2rem;
        }
        
        .stream-box h2,
        .stream-box h3 {
            font-weight: bold;
            margin: 1.5rem 0 0.8rem 0;
            color: var(--blue-400);
        }
        
        .stream-box h2 {
            font-size: 1.5rem;
        }
        
        .stream-box h3 {
            font-size: 1.25rem;
        }
        
        table {
            border-collapse: collapse;
            width: 100%;
            font-size: 13px;
        }
        
        th, td {
            border: 1px solid var(--border-color);
            padding: 10px;
            text-align: left;
            transition: all 0.2s ease;
        }
        
        th {
            background: var(--hover-bg);
            color: var(--gray-400);
            font-weight: bold;
        }
        
        tr:hover td {
            background: rgba(88, 166, 255, 0.05);
        }
        
        .highlight {
            color: var(--blue-400);
            font-weight: bold;
        }
        
        .market-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
        }
        
        .market-item {
            background: var(--hover-bg);
            border-radius: 6px;
            padding: 12px;
            border: 1px solid var(--border-color);
            transition: all 0.2s ease;
        }
        
        .market-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }
        
        .market-label {
            font-size: 12px;
            color: var(--gray-400);
            margin-bottom: 4px;
        }
        
        .market-value {
            font-size: 16px;
            font-weight: 500;
        }
        
        .market-value.positive {
            color: var(--red-400);
        }
        
        .market-value.negative {
            color: var(--green-400);
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .pulse {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(88, 166, 255, 0.4);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(88, 166, 255, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(88, 166, 255, 0);
            }
        }
        
        /* è¾“å…¥æ¡†æ ·å¼ */
        input[type="text"],
        input[type="password"],
        input[type="number"] {
            background: var(--input-bg);
            border: 1px solid var(--border-color);
            color: var(--text-color);
            transition: all 0.3s ease;
        }
        
        input[type="text"]:focus,
        input[type="password"]:focus,
        input[type="number"]:focus {
            outline: none;
            border-color: var(--blue-400);
            box-shadow: 0 0 0 2px rgba(88, 166, 255, 0.2);
        }
        
        /* å†å²è®°å½•é¡¹æ ·å¼ */
        .history-item {
            transition: all 0.3s ease;
        }
        
        .history-item:hover {
            background-color: var(--hover-bg);
        }
        
        /* å†å²è®°å½•åˆ—è¡¨é¡¹æ‚¬åœæ ·å¼ */
        #historyList > div:hover {
            background-color: var(--hover-bg);
        }
        
        /* ä¸»é¢˜åˆ‡æ¢æŒ‰é’®æ ·å¼ */
        #themeToggle {
            transition: all 0.3s ease;
        }
        
        #themeToggle:hover {
            background-color: var(--hover-bg);
        }
        
        /* æŒ‰é’®æ ·å¼ */
        button {
            transition: all 0.3s ease;
        }
        
        /* æœç´¢ç»“æœé¡¹æ‚¬åœæ ·å¼ */
        .stock-item:hover {
            background-color: var(--hover-bg);
        }
        
        /* ä¸‹æ‹‰èœå•å’Œå¸¦å±‚çº§éƒ¨åˆ†æ ·å¼ */
        #userMenu {
            background-color: var(--card-bg);
            border-color: var(--border-color);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        #searchResults {
            background-color: var(--input-bg);
            border-color: var(--border-color);
        }
        
        /* æ¨¡å‹é€‰æ‹©ä¸‹æ‹‰æ¡† */
        #modelSelect {
            background-color: var(--input-bg);
            color: var(--text-color);
        }
        
        /* å“åº”å¼è°ƒæ•´ */
        @media (max-width: 768px) {
            /* åŸºç¡€å­—ä½“å¤§å° */
            body {
                font-size: 16px;
                padding: 0.5rem;
            }
            
            /* ä¸»å®¹å™¨å®½åº¦ */
            .max-w-6xl.mx-auto {
                width: 95%;
                max-width: 100%;
            }
            
            /* æ ‡é¢˜å¤§å° */
            h1 {
                font-size: 1.5rem;
            }
            
            h2 {
                font-size: 1.25rem;
            }
            
            h3 {
                font-size: 1.1rem;
            }
            
            /* å¤´éƒ¨å¯¼èˆª */
            .flex.justify-between.items-center.mb-6 {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }
            
            .flex.justify-between.items-center.mb-6 > div {
                width: 100%;
                display: flex;
                justify-content: space-between;
            }
            
            /* æŒ‰é’®å¤§å° */
            button {
                font-size: 1rem;
                padding: 0.875rem 1.75rem;
                min-height: 44px;
            }
            
            /* è¾“å…¥æ¡†å¤§å° */
            input {
                font-size: 1rem;
                padding: 0.875rem;
                min-height: 44px;
            }
            
            /* ç½‘æ ¼å¸ƒå±€ */
            .market-grid {
                grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
                gap: 10px;
            }
            
            /* å¡ç‰‡æ ·å¼ */
            .card {
                padding: 1.25rem;
            }
            
            /* è¡¨å•å¸ƒå±€ */
            #stockForm {
                gap: 1rem;
                grid-template-columns: 1fr !important;
            }
            
            #stockForm > div {
                grid-column: 1 !important;
            }
            
            /* ç§»åŠ¨ç«¯å†å²æŒ‰é’® */
            #mobileHistoryBtn {
                bottom: 20px;
                left: 20px;
                width: 64px;
                height: 64px;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 1.75rem;
            }
            
            /* è¿›åº¦æ¡ */
            #progressBarContainer {
                padding: 1rem;
            }
            
            /* æ–°é—»åˆ—è¡¨å’Œåˆ†ææŠ¥å‘Š */
            #newsList,
            #streamOutput {
                font-size: 1rem;
            }
        }
        
        /* PCç«¯è°ƒæ•´ */
        @media (min-width: 769px) {
            /* åŸºç¡€å­—ä½“å¤§å° */
            body {
                font-size: 16px;
                padding: 1.5rem;
            }
            
            /* æ ‡é¢˜å¤§å° */
            h1 {
                font-size: 2rem;
            }
            
            h2 {
                font-size: 1.5rem;
            }
            
            h3 {
                font-size: 1.25rem;
            }
        }
        </style>
</head>
<body data-theme="light">

<div class="max-w-6xl mx-auto">
    <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center gap-4 mb-6">
        <h1 class="text-2xl font-bold flex items-center gap-2">ğŸ“Š AI è‚¡ç¥¨ç©¿é€åˆ†æç³»ç»Ÿ</h1>
        <div class="flex flex-wrap items-center gap-3 w-full lg:w-auto">
            <button type="button" id="exportBtn" class="flex items-center gap-2 px-4 py-2 rounded-full border border-border-color hover:bg-hover-bg transition-colors">
                ğŸ“¤ å¯¼å‡º
            </button>
            <div class="flex items-center gap-2 px-4 py-2 rounded-full border border-border-color bg-hover-bg">
                <span class="text-gray-400">æ¨¡å‹:</span>
                <select id="modelSelect" class="bg-input-bg border-none text-sm outline-none focus:ring-0">
                    <option value="deepseek-chat">æ ‡å‡†æ¨¡å¼</option>
                    <option value="deepseek-reasoner">æ€è€ƒæ¨¡å¼</option>
                </select>
            </div>
            <button type="button" id="themeToggle" class="flex items-center gap-2 px-4 py-2 rounded-full border border-border-color hover:bg-hover-bg transition-colors">
                <span class="dark-icon hidden">ğŸŒ™</span>
                <span class="light-icon">â˜€ï¸</span>
                <span class="dark-text hidden">æ·±è‰²æ¨¡å¼</span>
                <span class="light-text">æµ…è‰²æ¨¡å¼</span>
            </button>
            <div id="userInfo" class="flex items-center gap-3 flex-1 lg:flex-none">
                <button type="button" id="loginBtn" class="flex items-center gap-2 px-4 py-2 rounded-full border border-border-color hover:bg-hover-bg transition-colors">
                    ğŸ” ç™»å½•
                </button>
                <div id="userPoints" class="hidden flex items-center gap-2 px-4 py-2 rounded-full border border-border-color bg-hover-bg">
                    <span>ğŸ’</span>
                    <span id="pointsValue">0</span>
                </div>
                <div id="userDropdown" class="hidden">
                    <button type="button" id="userMenuBtn" class="flex items-center gap-2 px-4 py-2 rounded-full border border-border-color hover:bg-hover-bg transition-colors">
                        <span id="userName">ç”¨æˆ·</span>
                        <span>â–¼</span>
                    </button>
                    <div id="userMenu" class="hidden absolute right-4 top-20 bg-card-bg border border-border-color rounded-lg shadow-lg py-2 z-50">
                    <button type="button" id="updateUserBtn" class="w-full text-left px-4 py-2 hover:bg-hover-bg transition-colors">
                        ğŸ‘¤ ä¿®æ”¹ä¿¡æ¯
                    </button>
                    <button type="button" id="changePasswordBtn" class="w-full text-left px-4 py-2 hover:bg-hover-bg transition-colors">
                        ğŸ”’ ä¿®æ”¹å¯†ç 
                    </button>
                    <button type="button" id="refreshPointsBtn" class="w-full text-left px-4 py-2 hover:bg-hover-bg transition-colors">
                        ğŸ”„ åˆ·æ–°ç§¯åˆ†
                    </button>
                    <button type="button" id="rechargeBtn" class="w-full text-left px-4 py-2 hover:bg-hover-bg transition-colors">
                        âš¡ å……å€¼
                    </button>
                    <button type="button" id="pointsHistoryBtn" class="w-full text-left px-4 py-2 hover:bg-hover-bg transition-colors">
                        ğŸ“‹ ç§¯åˆ†å†å²
                    </button>
                    <button type="button" id="dragonStocksBtn" class="w-full text-left px-4 py-2 hover:bg-hover-bg transition-colors">
                        ğŸ‰ é¾™å¤´è‚¡æ¨è
                    </button>
                    <button type="button" id="logoutBtn" class="w-full text-left px-4 py-2 hover:bg-hover-bg transition-colors">
                        ğŸšª é€€å‡ºç™»å½•
                    </button>
                </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ç§»åŠ¨ç«¯å†å²æŒ‰é’® -->
    <button type="button" id="mobileHistoryBtn" class="lg:hidden fixed bottom-20 left-4 bg-card-bg border border-border-color rounded-full p-3 shadow-lg z-40">
        ğŸ“‹
    </button>
    
    <!-- åŠŸèƒ½å†…å®¹å®¹å™¨ -->
    <div id="functionalityContainer" class="hidden">
        <div class="flex flex-col lg:flex-row gap-6">
            <!-- å·¦ä¾§å†å²è®°å½• -->
            <div class="lg:w-1/3 hidden lg:block" id="historyContainer">
                <div id="historyCard" class="card p-6 sticky top-4">
                    <h3 class="text-sm font-bold text-gray-400 mb-3 flex items-center gap-2">
                        <span class="w-2 h-2 bg-blue-500 rounded-full animate-pulse"></span> å†å²åˆ†æè®°å½•
                    </h3>
                    <div id="historyList" class="overflow-y-auto max-h-[calc(100vh-200px)]">
                        <div class="text-gray-400 text-center py-8" id="emptyHistory">
                            æš‚æ— å†å²åˆ†æè®°å½•
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- å³ä¾§ä¸»è¦å†…å®¹ -->
            <div class="lg:w-2/3 space-y-6">
                <div class="card p-6">
                    <form id="stockForm" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <input type="hidden" name="apiKey" id="hiddenApiKeyInput">
                <input type="hidden" name="model" id="hiddenModelInput">
                

                <div class="md:col-span-3">
                    <label class="block text-xs text-gray-500 mb-1">è‚¡ç¥¨/åŸºé‡‘åç§°æœç´¢</label>
                    <div class="flex gap-2">
                        <input type="text" id="stockName" placeholder="è¾“å…¥è‚¡ç¥¨/åŸºé‡‘åç§°" class="flex-1 bg-input-bg border border-border-color rounded p-2 outline-none">
                        <button type="button" id="searchBtn" class="btn-primary text-white font-bold py-2 px-4 rounded">æœç´¢</button>
                    </div>
                    <div id="searchResults" class="mt-2 bg-input-bg border border-border-color rounded p-2 max-h-60 overflow-y-auto hidden"></div>
                </div>
                <div>
                    <label class="block text-xs text-gray-500 mb-1">è‚¡ç¥¨/åŸºé‡‘ä»£ç  (å¦‚: 000001/518880)</label>
                    <input type="text" name="symbol" required placeholder="000001/518880" class="w-full bg-input-bg border border-border-color rounded p-2 outline-none">
                </div>
                <div>
                    <label class="block text-xs text-gray-500 mb-1">æŒæœ‰æ•°é‡ / å¯å–å‡ºæ•°é‡ / æˆæœ¬</label>
                    <div class="flex gap-1">
                        <input type="number" name="shares" placeholder="æŒæœ‰è‚¡æ•°" class="w-1/3 bg-input-bg border border-border-color rounded p-2 outline-none">
                        <input type="number" name="sellable_shares" placeholder="å¯å–å‡ºè‚¡æ•°" class="w-1/3 bg-input-bg border border-border-color rounded p-2 outline-none">
                        <input type="number" step="0.01" name="cost" placeholder="æˆæœ¬" class="w-1/3 bg-input-bg border border-border-color rounded p-2 outline-none">
                    </div>
                </div>
                <div>
                    <label class="block text-xs text-gray-500 mb-1">å¯ç”¨èµ„é‡‘</label>
                    <input type="number" name="cash" value="10000" class="w-full bg-input-bg border border-border-color rounded p-2 outline-none">
                </div>
                
                <!-- å¤ç›˜æ•°æ®è¾“å…¥ -->
                <div class="md:col-span-3">
                    <div class="flex justify-between items-center mb-2">
                        <label class="block text-xs text-gray-500">å¤ç›˜æ•°æ®</label>
                        <button type="button" id="addReviewBtn" class="text-xs text-blue-400 hover:text-blue-300">æ·»åŠ è®°å½•</button>
                    </div>
                    <div id="reviewDataContainer" class="space-y-3">
                        <!-- å¤ç›˜è®°å½•å°†åœ¨è¿™é‡ŒåŠ¨æ€æ·»åŠ  -->
                    </div>
                    <div id="emptyReviewHint" class="text-xs text-gray-400 text-center py-4">
                        ç‚¹å‡»"æ·»åŠ è®°å½•"æŒ‰é’®å½•å…¥å½“å¤©çš„ä¹°å–æ•°æ®
                    </div>
                </div>
                
                <!-- èµ„è®¯è®¾ç½® -->
                <div class="md:col-span-3">
                    <div class="flex items-center gap-2">
                        <input type="checkbox" id="fullContentToggle" name="fullContent" class="w-4 h-4">
                        <label for="fullContentToggle" class="text-sm">è·å–å…¨éƒ¨èµ„è®¯æ­£æ–‡å†…å®¹ï¼ˆé»˜è®¤åªæˆªå–500å­—ç¬¦ï¼‰</label>
                    </div>
                </div>
                
                <!-- åŸºé‡‘æ€»ç›‘åŠŸèƒ½ -->
                <div class="md:col-span-3">
                    <div class="flex items-center gap-2">
                        <input type="checkbox" id="fundDirectorToggle" name="fundDirector" class="w-4 h-4">
                        <label for="fundDirectorToggle" class="text-sm">å¯ç”¨åŸºé‡‘æ€»ç›‘åŠŸèƒ½ï¼ˆåˆ†æå®Œæˆåç”±AIå†³å®šå…·ä½“æ“ä½œï¼‰</label>
                    </div>
                </div>
                
                <!-- å‡çº¿è®¡ç®—è®¾ç½® -->
                <div class="md:col-span-3">
                    <div class="flex items-center gap-2">
                        <input type="checkbox" id="includeRealTimeToggle" name="includeRealTime" checked class="w-4 h-4">
                        <label for="includeRealTimeToggle" class="text-sm">åŒ…å«å®æ—¶ä»·æ ¼è®¡ç®—å‡çº¿ï¼ˆå‹¾é€‰åï¼Œä»Šå¤©å¼€ç›˜æ—¶ä¼šä½¿ç”¨å®æ—¶ä»·æ ¼è®¡ç®—ï¼Œå‰é¢çš„å¤©æ•°å°‘å–ä¸€å¤©ï¼‰</label>
                    </div>
                </div>
                
                <!-- æˆ˜æ³•é€‰æ‹© -->
                <div class="md:col-span-3">
                    <label class="block text-xs text-gray-500 mb-2">æˆ˜æ³•é€‰æ‹©ï¼ˆå¯å¤šé€‰ï¼‰</label>
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-2 max-h-60 overflow-y-auto p-3 bg-hover-bg rounded border border-border-color">
                        <label class="flex items-center gap-2 text-sm cursor-pointer hover:bg-card-bg p-2 rounded transition-colors">
                            <input type="checkbox" name="strategies[]" value="5/20å‡çº¿äº¤å‰ (é‡‘å‰æ­»å‰)" class="w-4 h-4">
                            <span>5/20å‡çº¿äº¤å‰ (é‡‘å‰æ­»å‰)</span>
                        </label>
                        <label class="flex items-center gap-2 text-sm cursor-pointer hover:bg-card-bg p-2 rounded transition-colors">
                            <input type="checkbox" name="strategies[]" value="10/30å‡çº¿äº¤å‰ (åŒçº¿æ³¢æ®µ)" class="w-4 h-4">
                            <span>10/30å‡çº¿äº¤å‰ (åŒçº¿æ³¢æ®µ)</span>
                        </label>
                        <label class="flex items-center gap-2 text-sm cursor-pointer hover:bg-card-bg p-2 rounded transition-colors">
                            <input type="checkbox" name="strategies[]" value="20/60å‡çº¿äº¤å‰ (é•¿çº¿è¶‹åŠ¿)" class="w-4 h-4">
                            <span>20/60å‡çº¿äº¤å‰ (é•¿çº¿è¶‹åŠ¿)</span>
                        </label>
                        <label class="flex items-center gap-2 text-sm cursor-pointer hover:bg-card-bg p-2 rounded transition-colors">
                            <input type="checkbox" name="strategies[]" value="MACDé›¶è½´æˆ˜æ³• (è¿‡é›¶è½´)" class="w-4 h-4">
                            <span>MACDé›¶è½´æˆ˜æ³• (è¿‡é›¶è½´)</span>
                        </label>
                        <label class="flex items-center gap-2 text-sm cursor-pointer hover:bg-card-bg p-2 rounded transition-colors">
                            <input type="checkbox" name="strategies[]" value="MACDä¿¡å·çº¿ (çº¢ç»¿æŸ±)" class="w-4 h-4">
                            <span>MACDä¿¡å·çº¿ (çº¢ç»¿æŸ±)</span>
                        </label>
                        <label class="flex items-center gap-2 text-sm cursor-pointer hover:bg-card-bg p-2 rounded transition-colors">
                            <input type="checkbox" name="strategies[]" value="RSIéœ‡è¡æˆ˜æ³• (60ä¹°40å–)" class="w-4 h-4">
                            <span>RSIéœ‡è¡æˆ˜æ³• (60ä¹°40å–)</span>
                        </label>
                        <label class="flex items-center gap-2 text-sm cursor-pointer hover:bg-card-bg p-2 rounded transition-colors">
                            <input type="checkbox" name="strategies[]" value="KDJæå€¼åè½¬ (Jçº¿æ¢åº•)" class="w-4 h-4">
                            <span>KDJæå€¼åè½¬ (Jçº¿æ¢åº•)</span>
                        </label>
                        <label class="flex items-center gap-2 text-sm cursor-pointer hover:bg-card-bg p-2 rounded transition-colors">
                            <input type="checkbox" name="strategies[]" value="å¸ƒæ—å¸¦çªç ´ (ä¸Šä¸‹è½¨)" class="w-4 h-4">
                            <span>å¸ƒæ—å¸¦çªç ´ (ä¸Šä¸‹è½¨)</span>
                        </label>
                        <label class="flex items-center gap-2 text-sm cursor-pointer hover:bg-card-bg p-2 rounded transition-colors">
                            <input type="checkbox" name="strategies[]" value="å¸ƒæ—å¸¦å‡å€¼å›å½’ (æ¢åº•å›å‡)" class="w-4 h-4">
                            <span>å¸ƒæ—å¸¦å‡å€¼å›å½’ (æ¢åº•å›å‡)</span>
                        </label>
                        <label class="flex items-center gap-2 text-sm cursor-pointer hover:bg-card-bg p-2 rounded transition-colors">
                            <input type="checkbox" name="strategies[]" value="CCIé¡ºåŠ¿æŒ‡æ ‡ (+-100çªç ´)" class="w-4 h-4">
                            <span>CCIé¡ºåŠ¿æŒ‡æ ‡ (+-100çªç ´)</span>
                        </label>
                        <label class="flex items-center gap-2 text-sm cursor-pointer hover:bg-card-bg p-2 rounded transition-colors">
                            <input type="checkbox" name="strategies[]" value="å¤©é‡çªç ´ (2å€é‡ä¸Šæ¶¨)" class="w-4 h-4">
                            <span>å¤©é‡çªç ´ (2å€é‡ä¸Šæ¶¨)</span>
                        </label>
                        <label class="flex items-center gap-2 text-sm cursor-pointer hover:bg-card-bg p-2 rounded transition-colors">
                            <input type="checkbox" name="strategies[]" value="å”å¥‡å®‰é€šé“ (20å‘¨çªç ´)" class="w-4 h-4">
                            <span>å”å¥‡å®‰é€šé“ (20å‘¨çªç ´)</span>
                        </label>
                        <label class="flex items-center gap-2 text-sm cursor-pointer hover:bg-card-bg p-2 rounded transition-colors">
                            <input type="checkbox" name="strategies[]" value="ä¸Šå‘¨é«˜ä½ç‚¹ (å‘¨Kçªç ´)" class="w-4 h-4">
                            <span>ä¸Šå‘¨é«˜ä½ç‚¹ (å‘¨Kçªç ´)</span>
                        </label>
                        <label class="flex items-center gap-2 text-sm cursor-pointer hover:bg-card-bg p-2 rounded transition-colors">
                            <input type="checkbox" name="strategies[]" value="ä¸‰é˜³ä¹°ä¸¤é˜´å– (å½¢æ€è·Ÿè¸ª)" class="w-4 h-4">
                            <span>ä¸‰é˜³ä¹°ä¸¤é˜´å– (å½¢æ€è·Ÿè¸ª)</span>
                        </label>
                        <label class="flex items-center gap-2 text-sm cursor-pointer hover:bg-card-bg p-2 rounded transition-colors">
                            <input type="checkbox" name="strategies[]" value="åŠä»“å®šæŠ• (æœˆæŠ•2ä¸‡)" class="w-4 h-4">
                            <span>åŠä»“å®šæŠ• (æœˆæŠ•2ä¸‡)</span>
                        </label>
                        <label class="flex items-center gap-2 text-sm cursor-pointer hover:bg-card-bg p-2 rounded transition-colors">
                            <input type="checkbox" name="strategies[]" value="åŠä»“å°ç½‘æ ¼ (5%é—´è·)" class="w-4 h-4">
                            <span>åŠä»“å°ç½‘æ ¼ (5%é—´è·)</span>
                        </label>
                        <label class="flex items-center gap-2 text-sm cursor-pointer hover:bg-card-bg p-2 rounded transition-colors">
                            <input type="checkbox" name="strategies[]" value="åŠä»“å¤§ç½‘æ ¼ (10%é—´è·)" class="w-4 h-4">
                            <span>åŠä»“å¤§ç½‘æ ¼ (10%é—´è·)</span>
                        </label>
                    </div>
                </div>
                
                <button type="submit" id="submitBtn" class="md:col-span-3 btn-primary text-white font-bold py-3 rounded mt-2 shadow-lg">å¼€å§‹å®æ—¶æ•°æ®åˆ†æ</button>
            </form>
        </div>

        <div id="marketDataCard" class="card p-6 hidden">
            <h3 class="text-sm font-bold text-gray-400 mb-3 flex items-center gap-2">
                <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span> å®æ—¶ç›˜å£æ•°æ® (è…¾è®¯è´¢ç»)
            </h3>
            <div id="fullDataTable" class="overflow-x-auto">
                </div>
        </div>

        <div id="newsCard" class="card p-6 hidden">
            <h3 class="text-sm font-bold text-gray-400 mb-3 flex items-center gap-2">
                <span class="w-2 h-2 bg-yellow-500 rounded-full animate-pulse"></span> æœ€æ–°èµ„è®¯ (æ–°æµªè´¢ç»)
            </h3>
            <div id="newsList" class="overflow-y-auto max-h-96">
                </div>
        </div>

        <div id="reportCard" class="card p-8 hidden">
            <div id="streamOutput" class="stream-box text-sm md:text-base"></div>
        </div>
    </div>
            </div>
        </div>
    </div>
    
    <!-- ç™»å½•æç¤º -->
    <div id="loginPrompt" class="text-center py-12">
        <div class="max-w-md mx-auto">
            <div class="card p-8">
                <h2 class="text-2xl font-bold mb-6">è¯·å…ˆç™»å½•</h2>
                <p class="text-gray-400 mb-8">ç™»å½•åå³å¯ä½¿ç”¨AIè‚¡ç¥¨åˆ†æç³»ç»Ÿçš„æ‰€æœ‰åŠŸèƒ½</p>
                <button type="button" id="loginPromptBtn" class="btn-primary text-white font-bold py-3 px-8 rounded">
                    ç«‹å³ç™»å½•
                </button>
            </div>
        </div>
    </div>
    
    <!-- é¡µè„šå’Œå…è´£å£°æ˜ -->
    <footer class="mt-8 pt-6 border-t border-border-color">
        <div class="max-w-6xl mx-auto">
            <div class="card p-6">
                <h3 class="text-sm font-bold text-yellow-500 mb-3 flex items-center gap-2">
                    <span>âš ï¸</span> é£é™©æç¤ºä¸å…è´£å£°æ˜
                </h3>
                <div class="text-xs text-gray-400 space-y-2">
                    <p><strong>é‡è¦æç¤ºï¼š</strong>æœ¬ç³»ç»Ÿä»…ä¾›å­¦ä¹ ã€ç ”ç©¶å’Œå‚è€ƒä½¿ç”¨ï¼Œæ‰€æœ‰åˆ†æç»“æœå’Œæ•°æ®å‡ä¸æ„æˆä»»ä½•æŠ•èµ„å»ºè®®æˆ–äº¤æ˜“æŒ‡å¯¼ã€‚</p>
                    <p><strong>é£é™©æç¤ºï¼š</strong>è‚¡ç¥¨ã€åŸºé‡‘ç­‰é‡‘èäº§å“æŠ•èµ„å­˜åœ¨é£é™©ï¼ŒæŠ•èµ„è€…åº”æ ¹æ®è‡ªèº«æƒ…å†µè°¨æ…å†³ç­–ï¼Œè‡ªè¡Œæ‰¿æ‹…æŠ•èµ„é£é™©ã€‚</p>
                    <p><strong>æ•°æ®æ¥æºï¼š</strong>å¸‚åœºæ•°æ®æ¥æºäºä¸œæ–¹è´¢å¯Œã€è…¾è®¯è´¢ç»ã€æ–°æµªè´¢ç»ç­‰å…¬å¼€æ¸ é“ï¼Œæœ¬ç³»ç»Ÿä¸ä¿è¯æ•°æ®çš„å‡†ç¡®æ€§ã€å®Œæ•´æ€§å’ŒåŠæ—¶æ€§ã€‚</p>
                    <p><strong>ä½¿ç”¨é™åˆ¶ï¼š</strong>è¯·å‹¿å°†æœ¬ç³»ç»Ÿçš„åˆ†æç»“æœç”¨äºå®é™…æŠ•èµ„å†³ç­–ï¼Œå¦‚éœ€æŠ•èµ„å»ºè®®ï¼Œè¯·å’¨è¯¢æŒç‰Œé‡‘èæœºæ„æˆ–ä¸“ä¸šæŠ•èµ„é¡¾é—®ã€‚</p>
                </div>
            </div>
        </div>
    </footer>
</div>

<!-- å›ºå®šåœ¨åº•éƒ¨çš„è¿›åº¦æ¡ -->
<div class="fixed bottom-0 left-0 right-0 p-4 bg-card-bg border-t border-border-color hidden opacity-100" style="opacity: 1;" id="progressBarContainer">
    <div class="max-w-6xl mx-auto">
        <div class="flex justify-between items-center mb-1">
            <span class="text-xs text-gray-500" id="progressMessage">å‡†å¤‡å¼€å§‹...</span>
            <span class="text-xs text-gray-500" id="progressPercentage">0%</span>
        </div>
        <div class="w-full bg-input-bg border border-border-color rounded-full h-2">
            <div id="progressBar" class="bg-blue-500 h-2 rounded-full" style="width: 0%"></div>
        </div>
    </div>
</div>



<!-- å¯¼å‡ºé€‰é¡¹æ¨¡æ€æ¡† -->
<div id="exportModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="card p-6 max-w-md w-full max-h-[80vh] overflow-y-auto">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-lg font-bold">å¯¼å‡º</h2>
            <button type="button" id="closeExportBtn" class="text-gray-400 hover:text-gray-200">
                âœ•
            </button>
        </div>
        <div class="space-y-6">
            <div>
                <label class="block text-xs text-gray-500 mb-1">å¯¼å‡ºæ ¼å¼</label>
                <div class="space-y-2">
                    <div class="flex items-center">
                        <input type="radio" id="exportPdf" name="exportFormat" value="pdf" checked class="mr-2">
                        <label for="exportPdf">PDF</label>
                    </div>
                    <div class="flex items-center">
                        <input type="radio" id="exportImage" name="exportFormat" value="image" class="mr-2">
                        <label for="exportImage">å›¾ç‰‡</label>
                    </div>
                </div>
            </div>
            <div>
                <label class="block text-xs text-gray-500 mb-1">å¯¼å‡ºå†…å®¹</label>
                <div class="space-y-2">
                    <div class="flex items-center">
                        <input type="checkbox" id="exportMarketData" name="exportContent" value="marketData" checked class="mr-2">
                        <label for="exportMarketData">ç›˜å£æ•°æ®</label>
                    </div>
                    <div class="flex items-center">
                        <input type="checkbox" id="exportNews" name="exportContent" value="news" checked class="mr-2">
                        <label for="exportNews">æœ€æ–°èµ„è®¯</label>
                    </div>
                    <div class="flex items-center">
                        <input type="checkbox" id="exportAnalysis" name="exportContent" value="analysis" checked class="mr-2">
                        <label for="exportAnalysis">åˆ†ææ•°æ®</label>
                    </div>
                </div>
            </div>
            <div class="pt-4">
                <button type="button" id="startExportBtn" class="btn-primary text-white font-bold py-2 px-4 rounded w-full">å¼€å§‹å¯¼å‡º</button>
            </div>
        </div>
    </div>
</div>

<!-- ç§»åŠ¨ç«¯å†å²è®°å½•æ¨¡æ€æ¡† -->
<div id="mobileHistoryModal" class="lg:hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="card p-6 max-w-md w-full max-h-[80vh] overflow-y-auto">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-lg font-bold">å†å²åˆ†æè®°å½•</h2>
            <button type="button" id="closeMobileHistoryBtn" class="text-gray-400 hover:text-gray-200">
                âœ•
            </button>
        </div>
        <div id="mobileHistoryList" class="overflow-y-auto max-h-[calc(80vh-100px)]">
            <div class="text-gray-400 text-center py-8" id="mobileEmptyHistory">
                æš‚æ— å†å²åˆ†æè®°å½•
            </div>
        </div>
    </div>
</div>

<!-- ç™»å½•æ¨¡æ€æ¡† -->
<div id="loginModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="card p-6 max-w-md w-full max-h-[80vh] overflow-y-auto">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-lg font-bold">ç”¨æˆ·ç™»å½•</h2>
            <button type="button" id="closeLoginBtn" class="text-gray-400 hover:text-gray-200">
                âœ•
            </button>
        </div>
        <div class="space-y-6">
            <div>
                <label class="block text-xs text-gray-500 mb-1">ç”¨æˆ·å</label>
                <input type="text" id="loginUsername" class="w-full bg-input-bg border border-border-color rounded p-2 outline-none focus:border-blue-500">
            </div>
            <div>
                <label class="block text-xs text-gray-500 mb-1">å¯†ç </label>
                <input type="password" id="loginPassword" class="w-full bg-input-bg border border-border-color rounded p-2 outline-none focus:border-blue-500">
            </div>
            <div class="pt-4">
                <button type="button" id="submitLoginBtn" class="btn-primary text-white font-bold py-2 px-4 rounded w-full">ç™»å½•</button>
            </div>
            <div class="text-center pt-4">
                <span class="text-gray-400">è¿˜æ²¡æœ‰è´¦å·ï¼Ÿ</span>
                <button type="button" id="switchToRegisterBtn" class="text-blue-400 hover:text-blue-300 ml-1">ç«‹å³æ³¨å†Œ</button>
            </div>
        </div>
    </div>
</div>

<!-- æ³¨å†Œæ¨¡æ€æ¡† -->
<div id="registerModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="card p-6 max-w-md w-full max-h-[80vh] overflow-y-auto">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-lg font-bold">ç”¨æˆ·æ³¨å†Œ</h2>
            <button type="button" id="closeRegisterBtn" class="text-gray-400 hover:text-gray-200">
                âœ•
            </button>
        </div>
        <div class="space-y-6">
            <div>
                <label class="block text-xs text-gray-500 mb-1">ç”¨æˆ·å</label>
                <input type="text" id="registerUsername" class="w-full bg-input-bg border border-border-color rounded p-2 outline-none focus:border-blue-500">
            </div>
            <div>
                <label class="block text-xs text-gray-500 mb-1">å¯†ç </label>
                <input type="password" id="registerPassword" class="w-full bg-input-bg border border-border-color rounded p-2 outline-none focus:border-blue-500">
            </div>
            <div>
                <label class="block text-xs text-gray-500 mb-1">æ˜µç§°</label>
                <input type="text" id="registerNickname" class="w-full bg-input-bg border border-border-color rounded p-2 outline-none focus:border-blue-500">
            </div>
            <div class="pt-4">
                <button type="button" id="submitRegisterBtn" class="btn-primary text-white font-bold py-2 px-4 rounded w-full">æ³¨å†Œ</button>
            </div>
            <div class="text-center pt-4">
                <span class="text-gray-400">å·²æœ‰è´¦å·ï¼Ÿ</span>
                <button type="button" id="switchToLoginBtn" class="text-blue-400 hover:text-blue-300 ml-1">ç«‹å³ç™»å½•</button>
            </div>
        </div>
    </div>
</div>

<!-- ä¿®æ”¹å¯†ç æ¨¡æ€æ¡† -->
<div id="changePasswordModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="card p-6 max-w-md w-full max-h-[80vh] overflow-y-auto">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-lg font-bold">ä¿®æ”¹å¯†ç </h2>
            <button type="button" id="closeChangePasswordBtn" class="text-gray-400 hover:text-gray-200">
                âœ•
            </button>
        </div>
        <div class="space-y-6">
            <div>
                <label class="block text-xs text-gray-500 mb-1">åŸå¯†ç </label>
                <input type="password" id="oldPassword" class="w-full bg-input-bg border border-border-color rounded p-2 outline-none focus:border-blue-500">
            </div>
            <div>
                <label class="block text-xs text-gray-500 mb-1">æ–°å¯†ç </label>
                <input type="password" id="newPassword" class="w-full bg-input-bg border border-border-color rounded p-2 outline-none focus:border-blue-500">
            </div>
            <div>
                <label class="block text-xs text-gray-500 mb-1">ç¡®è®¤æ–°å¯†ç </label>
                <input type="password" id="confirmPassword" class="w-full bg-input-bg border border-border-color rounded p-2 outline-none focus:border-blue-500">
            </div>
            <div class="pt-4">
                <button type="button" id="submitChangePasswordBtn" class="btn-primary text-white font-bold py-2 px-4 rounded w-full">ä¿®æ”¹å¯†ç </button>
            </div>
        </div>
    </div>
</div>

<!-- ä¿®æ”¹ç”¨æˆ·ä¿¡æ¯æ¨¡æ€æ¡† -->
<div id="updateUserModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="card p-6 max-w-md w-full max-h-[80vh] overflow-y-auto">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-lg font-bold">ä¿®æ”¹ç”¨æˆ·ä¿¡æ¯</h2>
            <button type="button" id="closeUpdateUserBtn" class="text-gray-400 hover:text-gray-200">
                âœ•
            </button>
        </div>
        <div class="space-y-6">
            <div>
                <label class="block text-xs text-gray-500 mb-1">ç”¨æˆ·å</label>
                <input type="text" id="updateUsername" class="w-full bg-input-bg border border-border-color rounded p-2 outline-none focus:border-blue-500">
            </div>
            <div>
                <label class="block text-xs text-gray-500 mb-1">æ˜µç§°</label>
                <input type="text" id="updateNickname" class="w-full bg-input-bg border border-border-color rounded p-2 outline-none focus:border-blue-500">
            </div>
            <div class="pt-4">
                <button type="button" id="submitUpdateUserBtn" class="btn-primary text-white font-bold py-2 px-4 rounded w-full">ä¿å­˜ä¿®æ”¹</button>
            </div>
        </div>
    </div>
</div>

<script>
    const form = document.getElementById('stockForm');
    const submitBtn = document.getElementById('submitBtn');
    const marketCard = document.getElementById('marketDataCard');
    const fullDataTable = document.getElementById('fullDataTable');
    const reportCard = document.getElementById('reportCard');
    const output = document.getElementById('streamOutput');
    const stockNameInput = document.getElementById('stockName');
    const searchBtn = document.getElementById('searchBtn');
    const searchResults = document.getElementById('searchResults');
    const symbolInput = document.querySelector('input[name="symbol"]');
    const historyCard = document.getElementById('historyCard');
    const historyList = document.getElementById('historyList');
    const emptyHistory = document.getElementById('emptyHistory');
    const newsCard = document.getElementById('newsCard');
    const newsList = document.getElementById('newsList');
    
    // æ¨¡å‹é€‰æ‹©ç›¸å…³å…ƒç´ 
    const modelSelect = document.getElementById('modelSelect');
    const hiddenApiKeyInput = document.getElementById('hiddenApiKeyInput');
    const hiddenModelInput = document.getElementById('hiddenModelInput');
    
    // å¯¼å‡ºåŠŸèƒ½ç›¸å…³å…ƒç´ 
    const exportBtn = document.getElementById('exportBtn');
    const exportModal = document.getElementById('exportModal');
    const closeExportBtn = document.getElementById('closeExportBtn');
    const startExportBtn = document.getElementById('startExportBtn');
    
    // ç§»åŠ¨ç«¯å†å²æŒ‰é’®ç›¸å…³å…ƒç´ 
    const mobileHistoryBtn = document.getElementById('mobileHistoryBtn');
    const mobileHistoryModal = document.getElementById('mobileHistoryModal');
    const closeMobileHistoryBtn = document.getElementById('closeMobileHistoryBtn');
    const mobileHistoryList = document.getElementById('mobileHistoryList');
    const mobileEmptyHistory = document.getElementById('mobileEmptyHistory');
    
    // è¿›åº¦æ¡ç›¸å…³å…ƒç´ 
    const progressBarContainer = document.getElementById('progressBarContainer');
    const progressBar = document.getElementById('progressBar');
    const progressMessage = document.getElementById('progressMessage');
    const progressPercentage = document.getElementById('progressPercentage');
    
    // æµå¼æ–‡æœ¬å¤„ç†çš„çŠ¶æ€ç®¡ç†
    let textBuffer = '';
    let isProcessing = false;
    // ç”¨äºç´¯ç§¯æ‰€æœ‰HTMLå†…å®¹çš„å®Œæ•´ç¼“å†²åŒº
    let fullContentBuffer = '';
    
    // å­˜å‚¨å½“å‰åˆ†æçš„æ•°æ®
    let currentAnalysisData = {};
    
    // å­˜å‚¨æ“ä½œå‡½æ•°
    function setStorage(name, value, days) {
        try {
            // å¯¹äºå†å²è®°å½•ï¼Œä½¿ç”¨localStorageï¼Œé¿å…cookieå¤§å°é™åˆ¶
            if (name === 'stockAnalysisHistory') {
                localStorage.setItem(name, value);
                return true;
            }
            // å¯¹äºå…¶ä»–æ•°æ®ï¼ˆå¦‚API Keyï¼‰ï¼Œç»§ç»­ä½¿ç”¨cookie
            const expires = new Date();
            expires.setTime(expires.getTime() + (days * 24 * 60 * 60 * 1000));
            document.cookie = name + '=' + (value || '') + ';expires=' + expires.toUTCString() + ';path=/';
            return true;
        } catch (e) {
            console.error('å­˜å‚¨æ•°æ®å¤±è´¥:', e);
            return false;
        }
    }
    
    function getStorage(name) {
        try {
            // å¯¹äºå†å²è®°å½•ï¼Œä½¿ç”¨localStorage
            if (name === 'stockAnalysisHistory') {
                return localStorage.getItem(name);
            }
            // å¯¹äºå…¶ä»–æ•°æ®ï¼ˆå¦‚API Keyï¼‰ï¼Œç»§ç»­ä½¿ç”¨cookie
            const nameEQ = name + '=';
            const ca = document.cookie.split(';');
            for(let i=0;i < ca.length;i++) {
                let c = ca[i];
                while (c.charAt(0)==' ') c = c.substring(1,c.length);
                if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length,c.length);
            }
            return null;
        } catch (e) {
            console.error('è·å–æ•°æ®å¤±è´¥:', e);
            return null;
        }
    }
    
    // æ›´æ–°è¿›åº¦æ¡
    function updateProgress(percentage, message) {
        progressBar.style.width = `${percentage}%`;
        progressPercentage.textContent = `${percentage}%`;
        progressMessage.textContent = message;
    }
    
    // ä¿å­˜åˆ†ææ•°æ®åˆ°å†å²è®°å½•ï¼ˆæ•°æ®å·²åœ¨backend.phpä¸­ä¿å­˜åˆ°æ•°æ®åº“ï¼‰
    function saveAnalysisToHistory(analysisData) {
        console.log('åˆ†ææ•°æ®å·²åœ¨backend.phpä¸­ä¿å­˜åˆ°æ•°æ®åº“');
        // æ›´æ–°å†å²è®°å½•åˆ—è¡¨
        renderHistoryList();
    }
    
    // ä»æ•°æ®åº“åŠ è½½å†å²åˆ†æè®°å½•
    async function loadHistoryFromDatabase() {
        try {
            const response = await fetch('backend.php?action=history');
            const data = await response.json();
            return data || [];
        } catch (error) {
            console.error('åŠ è½½å†å²è®°å½•å¤±è´¥:', error);
            return [];
        }
    }
    
    // æŒ‰æ—¥æœŸåˆ†ç»„å†å²è®°å½•
    function groupHistoryByDate(history) {
        const groups = {};
        history.forEach((item, index) => {
            const date = new Date(item.created_at);
            const dateKey = getLocalDateKey(date); // ä½¿ç”¨æœ¬åœ°æ—¥æœŸ
            if (!groups[dateKey]) {
                groups[dateKey] = [];
            }
            groups[dateKey].push({ ...item, originalIndex: index });
        });
        return groups;
    }
    
    // è·å–æœ¬åœ°æ—¥æœŸçš„YYYY-MM-DDæ ¼å¼
    function getLocalDateKey(date) {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    }
    
    // æ ¼å¼åŒ–æ—¥æœŸæ˜¾ç¤º
    function formatDateDisplay(dateKey) {
        const [year, month, day] = dateKey.split('-').map(Number);
        const date = new Date(year, month - 1, day);
        const today = new Date();
        const yesterday = new Date(today);
        yesterday.setDate(yesterday.getDate() - 1);
        
        const todayKey = getLocalDateKey(today);
        const yesterdayKey = getLocalDateKey(yesterday);
        
        if (dateKey === todayKey) {
            return 'ä»Šå¤©';
        } else if (dateKey === yesterdayKey) {
            return 'æ˜¨å¤©';
        } else {
            return date.toLocaleDateString('zh-CN', { year: 'numeric', month: 'long', day: 'numeric' });
        }
    }
    
    // æ¸²æŸ“å†å²è®°å½•åˆ—è¡¨ï¼ˆæŒ‰æ—¥æœŸåˆ†ç»„ï¼Œå¯æŠ˜å ï¼‰
    async function renderHistoryList() {
        historyList.innerHTML = '<div class="text-blue-400 text-center py-8 animate-pulse">åŠ è½½å†å²è®°å½•ä¸­...</div>';
        mobileHistoryList.innerHTML = '<div class="text-blue-400 text-center py-8 animate-pulse">åŠ è½½å†å²è®°å½•ä¸­...</div>';
        
        const history = await loadHistoryFromDatabase();
        
        // æ¡Œé¢ç«¯å’Œç§»åŠ¨ç«¯å…±ç”¨æ¸²æŸ“é€»è¾‘
        const groups = groupHistoryByDate(history);
        const dateKeys = Object.keys(groups).sort((a, b) => new Date(b) - new Date(a)); // æŒ‰æ—¥æœŸå€’åº
        
        const renderContent = (isMobile = false) => {
            if (dateKeys.length === 0) {
                return '<div class="text-gray-400 text-center py-8">æš‚æ— å†å²åˆ†æè®°å½•</div>';
            }
            
            let html = '';
            let globalIndex = 0;
            
            dateKeys.forEach((dateKey) => {
                const items = groups[dateKey];
                const dateDisplay = formatDateDisplay(dateKey);
                const groupId = isMobile ? `mobile-group-${dateKey}` : `group-${dateKey}`;
                const toggleId = isMobile ? `mobile-toggle-${dateKey}` : `toggle-${dateKey}`;
                const contentId = isMobile ? `mobile-content-${dateKey}` : `content-${dateKey}`;
                
                html += `
                    <div class="mb-4" id="${groupId}">
                        <button type="button" class="w-full flex justify-between items-center p-3 bg-hover-bg rounded hover:bg-card-bg transition-colors" id="${toggleId}" data-date="${dateKey}" data-mobile="${isMobile}">
                            <div class="flex items-center gap-2">
                                <span class="toggle-icon">â–¼</span>
                                <span class="font-medium">${dateDisplay}</span>
                                <span class="text-xs text-gray-400">(${items.length}æ¡)</span>
                            </div>
                        </button>
                        <div class="mt-2 space-y-2" id="${contentId}">
                `;
                
                items.forEach((item) => {
                    const marketData = item.market_data ? JSON.parse(item.market_data) : {};
                    const stockName = marketData?.åç§° || item.symbol;
                    const time = new Date(item.created_at).toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
                    const dataIndex = isMobile ? `mobile-${globalIndex}` : globalIndex;
                    const modelName = item.model === 'deepseek-reasoner' ? 'æ€è€ƒæ¨¡å¼' : 'æ ‡å‡†æ¨¡å¼';
                    
                    html += `
                        <div class="border border-border-color p-3 rounded hover:bg-hover-bg transition-colors">
                            <div class="flex justify-between items-start">
                                <div>
                                    <h4 class="font-medium text-blue-400">${stockName}</h4>
                                    <div class="text-xs text-gray-400 mt-1">${time}</div>
                                </div>
                                <div class="flex gap-2">
                                    <button class="text-xs text-blue-400 hover:text-blue-300 ${isMobile ? 'mobile-view-history' : 'view-history'}" data-id="${item.id}">æŸ¥çœ‹</button>
                                    <button class="text-xs text-red-400 hover:text-red-300 ${isMobile ? 'mobile-delete-history' : 'delete-history'}" data-id="${item.id}">åˆ é™¤</button>
                                </div>
                            </div>
                            <div class="text-xs text-gray-500 mt-2">
                                ä»·æ ¼: ${marketData?.ä»·æ ¼ || 'N/A'} | æ¶¨è·Œå¹…: ${marketData?.['æ¶¨è·Œå¹…%'] || 'N/A'} | æ¨¡å‹: ${modelName}
                            </div>
                        </div>
                    `;
                    globalIndex++;
                });
                
                html += `
                        </div>
                    </div>
                `;
            });
            
            return html;
        };
        
        // æ¸²æŸ“æ¡Œé¢ç«¯
        if (dateKeys.length === 0) {
            emptyHistory.classList.remove('hidden');
            historyList.innerHTML = '';
        } else {
            emptyHistory.classList.add('hidden');
            historyList.innerHTML = renderContent(false);
        }
        
        // æ¸²æŸ“ç§»åŠ¨ç«¯
        if (dateKeys.length === 0) {
            mobileEmptyHistory.classList.remove('hidden');
            mobileHistoryList.innerHTML = '';
        } else {
            mobileEmptyHistory.classList.add('hidden');
            mobileHistoryList.innerHTML = renderContent(true);
        }
        
        // æ·»åŠ æŠ˜å /å±•å¼€äº‹ä»¶ç›‘å¬
        document.querySelectorAll('[id^="toggle-"], [id^="mobile-toggle-"]').forEach(btn => {
            btn.addEventListener('click', function() {
                const dateKey = this.dataset.date;
                const isMobile = this.dataset.mobile === 'true';
                const contentId = isMobile ? `mobile-content-${dateKey}` : `content-${dateKey}`;
                const toggleIcon = this.querySelector('.toggle-icon');
                const content = document.getElementById(contentId);
                
                if (content.style.display === 'none') {
                    content.style.display = 'block';
                    toggleIcon.textContent = 'â–¼';
                } else {
                    content.style.display = 'none';
                    toggleIcon.textContent = 'â–¶';
                }
            });
        });
        
        // æ·»åŠ æŸ¥çœ‹å†å²è®°å½•äº‹ä»¶ç›‘å¬
        document.querySelectorAll('.view-history, .mobile-view-history').forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.stopPropagation();
                const id = parseInt(this.dataset.id);
                console.log('ç‚¹å‡»æŸ¥çœ‹æŒ‰é’®ï¼ŒID:', id, 'å†å²æ•°æ®:', history);
                viewHistoryItemById(id, history);
                if (this.classList.contains('mobile-view-history')) {
                    mobileHistoryModal.classList.add('hidden');
                }
            });
        });
        
        // æ·»åŠ åˆ é™¤å†å²è®°å½•äº‹ä»¶ç›‘å¬
        document.querySelectorAll('.delete-history, .mobile-delete-history').forEach(btn => {
            btn.addEventListener('click', async function() {
                const id = parseInt(this.dataset.id);
                if (confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡å†å²è®°å½•å—ï¼Ÿ')) {
                    await deleteHistoryItemById(id);
                    await renderHistoryList();
                }
            });
        });
    }
    
    // æŠ€æœ¯æŒ‡æ ‡è¯´æ˜
    const indicatorDescriptions = {
        'EMA5': 'EMA5ï¼ˆ5æ—¥æŒ‡æ•°ç§»åŠ¨å¹³å‡çº¿ï¼‰ï¼šæœ€è¿‘5ä¸ªäº¤æ˜“æ—¥æ”¶ç›˜ä»·çš„åŠ æƒå¹³å‡å€¼ï¼Œä¾§é‡è¿‘æœŸä»·æ ¼ï¼Œæ¯”ç®€å•å‡çº¿æ›´æ•æ„Ÿï¼Œç”¨äºåˆ¤æ–­çŸ­æœŸè¶‹åŠ¿ã€‚',
        'EMA10': 'EMA10ï¼ˆ10æ—¥æŒ‡æ•°ç§»åŠ¨å¹³å‡çº¿ï¼‰ï¼šæœ€è¿‘10ä¸ªäº¤æ˜“æ—¥æ”¶ç›˜ä»·çš„åŠ æƒå¹³å‡å€¼ï¼Œç”¨äºåˆ¤æ–­ä¸­çŸ­æœŸè¶‹åŠ¿ã€‚',
        'EMA20': 'EMA20ï¼ˆ20æ—¥æŒ‡æ•°ç§»åŠ¨å¹³å‡çº¿ï¼‰ï¼šæœ€è¿‘20ä¸ªäº¤æ˜“æ—¥æ”¶ç›˜ä»·çš„åŠ æƒå¹³å‡å€¼ï¼Œå¸¸ç”¨äºåˆ¤æ–­ä¸­æœŸè¶‹åŠ¿å’Œä½œä¸ºå¸ƒæ—å¸¦çš„ä¸­è½¨ã€‚',
        'EMA30': 'EMA30ï¼ˆ30æ—¥æŒ‡æ•°ç§»åŠ¨å¹³å‡çº¿ï¼‰ï¼šæœ€è¿‘30ä¸ªäº¤æ˜“æ—¥æ”¶ç›˜ä»·çš„åŠ æƒå¹³å‡å€¼ï¼Œç”¨äºåˆ¤æ–­ä¸­é•¿æœŸè¶‹åŠ¿ã€‚',
        'EMA60': 'EMA60ï¼ˆ60æ—¥æŒ‡æ•°ç§»åŠ¨å¹³å‡çº¿ï¼‰ï¼šæœ€è¿‘60ä¸ªäº¤æ˜“æ—¥æ”¶ç›˜ä»·çš„åŠ æƒå¹³å‡å€¼ï¼Œç”¨äºåˆ¤æ–­é•¿æœŸè¶‹åŠ¿ï¼Œè¢«è§†ä¸ºé‡è¦çš„ç‰›ç†Šåˆ†ç•Œçº¿ã€‚',
        'RSI14': 'RSI14ï¼ˆ14æ—¥ç›¸å¯¹å¼ºå¼±æŒ‡æ ‡ï¼‰ï¼šå–å€¼0-100ã€‚RSI>70è¡¨ç¤ºè¶…ä¹°ï¼Œå¯èƒ½å›è°ƒï¼›RSI<30è¡¨ç¤ºè¶…å–ï¼Œå¯èƒ½åå¼¹ï¼›50å·¦å³ä¸ºä¸­æ€§ã€‚',
        'K': 'KDJ-Kå€¼ï¼šKDJæŒ‡æ ‡çš„å¿«é€Ÿçº¿ï¼Œåæ˜ å½“å‰ä»·æ ¼åœ¨è¿‘æœŸé«˜ä½ç‚¹çš„ä½ç½®ï¼Œå˜åŒ–è¾ƒå¿«ã€‚',
        'D': 'KDJ-Då€¼ï¼šKDJæŒ‡æ ‡çš„æ…¢é€Ÿçº¿ï¼Œæ˜¯Kå€¼çš„å¹³æ»‘ï¼Œå˜åŒ–è¾ƒæ…¢ï¼Œç”¨äºç¡®è®¤ä¿¡å·ã€‚',
        'J': 'KDJ-Jå€¼ï¼šKDJæŒ‡æ ‡çš„è¶…ä¹°è¶…å–çº¿ï¼Œæ˜¯3K-2Dï¼Œæœ€æ•æ„Ÿï¼ŒJ>100è¶…ä¹°ï¼ŒJ<0è¶…å–ã€‚',
        'MACD_DIF': 'MACD-DIFï¼ˆå¿«çº¿ï¼‰ï¼š12æ—¥æŒ‡æ•°ç§»åŠ¨å¹³å‡çº¿ä¸26æ—¥æŒ‡æ•°ç§»åŠ¨å¹³å‡çº¿çš„å·®å€¼ï¼Œåæ˜ çŸ­æœŸä¸é•¿æœŸä»·æ ¼è¶‹åŠ¿çš„å·®å¼‚ã€‚',
        'MACD_DEA': 'MACD-DEAï¼ˆæ…¢çº¿ï¼‰ï¼šDIFçš„9æ—¥æŒ‡æ•°ç§»åŠ¨å¹³å‡çº¿ï¼Œç”¨äºå¹³æ»‘DIFæ›²çº¿ï¼Œç¡®è®¤è¶‹åŠ¿å˜åŒ–ã€‚',
        'MACDæŸ±': 'MACDæŸ±ï¼š(DIF-DEA)*2ï¼Œç”¨äºè¡¡é‡DIFä¸DEAä¹‹é—´çš„è·ç¦»ï¼ŒæŸ±å­é¢œè‰²åæ˜ è¶‹åŠ¿æ–¹å‘ï¼Œé•¿åº¦åæ˜ è¶‹åŠ¿å¼ºåº¦ã€‚',
        'å¸ƒæ—å¸¦': 'å¸ƒæ—å¸¦ï¼ˆå¸ƒæ—çº¿ï¼‰ï¼šç”±ä¸‰æ¡çº¿ç»„æˆçš„é€šé“æŒ‡æ ‡ï¼Œä¸­è½¨é€šå¸¸ä¸º20æ—¥ç§»åŠ¨å¹³å‡çº¿ï¼Œä¸Šä¸‹è½¨ä¸ºä¸­è½¨Â±2å€æ ‡å‡†å·®ã€‚ç”¨äºåˆ¤æ–­ä»·æ ¼æ³¢åŠ¨èŒƒå›´å’Œæ”¯æ’‘å‹åŠ›ä½ï¼Œä»·æ ¼åœ¨é€šé“å†…æ³¢åŠ¨ï¼Œçªç ´ä¸Šä¸‹è½¨å¯èƒ½é¢„ç¤ºè¶‹åŠ¿å˜åŒ–ã€‚',
        'å¸ƒæ—çº¿': 'å¸ƒæ—å¸¦ï¼ˆå¸ƒæ—çº¿ï¼‰ï¼šç”±ä¸‰æ¡çº¿ç»„æˆçš„é€šé“æŒ‡æ ‡ï¼Œä¸­è½¨é€šå¸¸ä¸º20æ—¥ç§»åŠ¨å¹³å‡çº¿ï¼Œä¸Šä¸‹è½¨ä¸ºä¸­è½¨Â±2å€æ ‡å‡†å·®ã€‚ç”¨äºåˆ¤æ–­ä»·æ ¼æ³¢åŠ¨èŒƒå›´å’Œæ”¯æ’‘å‹åŠ›ä½ï¼Œä»·æ ¼åœ¨é€šé“å†…æ³¢åŠ¨ï¼Œçªç ´ä¸Šä¸‹è½¨å¯èƒ½é¢„ç¤ºè¶‹åŠ¿å˜åŒ–ã€‚',
        'å¸ƒæ—å¸¦ä¸Šè½¨': 'å¸ƒæ—å¸¦ä¸Šè½¨ï¼šå¸ƒæ—å¸¦é€šé“çš„ä¸Šè¾¹ç•Œï¼Œé€šå¸¸ä¸ºä¸­è½¨+2å€æ ‡å‡†å·®ï¼Œä»·æ ¼è§¦åŠä¸Šè½¨å¯èƒ½å—å‹å›è½ã€‚',
        'å¸ƒæ—å¸¦ä¸­è½¨': 'å¸ƒæ—å¸¦ä¸­è½¨ï¼šé€šå¸¸ä¸º20æ—¥ç§»åŠ¨å¹³å‡çº¿ï¼Œä»£è¡¨ä¸­æœŸè¶‹åŠ¿æ–¹å‘ã€‚',
        'å¸ƒæ—å¸¦ä¸‹è½¨': 'å¸ƒæ—å¸¦ä¸‹è½¨ï¼šå¸ƒæ—å¸¦é€šé“çš„ä¸‹è¾¹ç•Œï¼Œé€šå¸¸ä¸ºä¸­è½¨-2å€æ ‡å‡†å·®ï¼Œä»·æ ¼è§¦åŠä¸‹è½¨å¯èƒ½è·å¾—æ”¯æ’‘åå¼¹ã€‚',
        'ä»·æ ¼ä½ç½®': 'ä»·æ ¼ä½ç½®ï¼šå½“å‰ä»·æ ¼åœ¨å¸ƒæ—å¸¦ä¸Šä¸‹è½¨ä¹‹é—´çš„ç™¾åˆ†æ¯”ä½ç½®ï¼Œ0%åœ¨ä¸‹è½¨ï¼Œ100%åœ¨ä¸Šè½¨ï¼Œ50%åœ¨ä¸­è½¨ã€‚',
        'CCI': 'CCIï¼ˆé¡ºåŠ¿æŒ‡æ ‡ï¼‰ï¼šè¡¡é‡ä»·æ ¼åç¦»å…¶å¹³å‡æ°´å¹³çš„ç¨‹åº¦ï¼Œæ­£å¸¸å€¼èŒƒå›´ä¸º-100åˆ°100ã€‚CCI>100è¡¨ç¤ºè¶…ä¹°ï¼Œå¯èƒ½å›è°ƒï¼›CCI<-100è¡¨ç¤ºè¶…å–ï¼Œå¯èƒ½åå¼¹ï¼›-100åˆ°100ä¹‹é—´ä¸ºæ­£å¸¸åŒºé—´ã€‚'
    };
    
    // æ ¼å¼åŒ–èµ„é‡‘æµå‘æ•°æ®ï¼ˆå•ä½ï¼šä¸‡å…ƒï¼‰
    function formatMoneyFlow(value) {
        if (value === null || value === undefined || value === '') return '-';
        const num = parseFloat(value);
        if (isNaN(num)) return value;
        
        // valueæ˜¯ä¸‡å…ƒï¼Œå…ˆè½¬æ¢ä¸ºå…ƒ
        const yuan = num * 10000;
        const absYuan = Math.abs(yuan);
        let formatted = '';
        
        if (absYuan >= 100000000) {
            formatted = (yuan / 100000000).toFixed(2) + 'äº¿';
        } else if (absYuan >= 10000) {
            formatted = (yuan / 10000).toFixed(2) + 'ä¸‡';
        } else {
            formatted = yuan.toFixed(0) + 'å…ƒ';
        }
        
        return formatted;
    }
    
    // æŸ¥çœ‹å†å²è®°å½•è¯¦æƒ…ï¼ˆé€šè¿‡IDï¼‰
    function viewHistoryItemById(id, history) {
        console.log('viewHistoryItemByIdè¢«è°ƒç”¨ï¼Œid:', id, 'history:', history);
        const item = history.find(h => parseInt(h.id) === id);
        console.log('æ‰¾åˆ°çš„item:', item);
        
        if (item) {
            const marketData = item.market_data ? JSON.parse(item.market_data) : null;
            const indexData = item.index_data ? JSON.parse(item.index_data) : null;
            const newsData = item.news_data ? JSON.parse(item.news_data) : null;
            const sectorData = item.sector_data ? JSON.parse(item.sector_data) : null;
            const moneyFlowData = item.moneyflow_data ? JSON.parse(item.moneyflow_data) : null;
            const technicalData = item.technical_data ? JSON.parse(item.technical_data) : null;
            const reviewData = item.review_data ? JSON.parse(item.review_data) : null;
            const aiContent = item.ai_content || '';
            const fundDirectorContent = item.fund_director_content || '';
            
            console.log('è§£æåçš„æ•°æ®:', { marketData, indexData, newsData, sectorData, moneyFlowData, technicalData, reviewData, aiContent, fundDirectorContent });
            
            // æ•´åˆæ•°æ®
            let enhancedMarketData = marketData || {};
            console.log('åŸå§‹marketData:', enhancedMarketData);
            
            if (sectorData && Object.keys(sectorData).length > 0) {
                enhancedMarketData['æ¿å—ä¿¡æ¯'] = sectorData;
            }
            if (moneyFlowData && Object.keys(moneyFlowData).length > 0) {
                enhancedMarketData['èµ„é‡‘æµå‘'] = moneyFlowData;
            }
            if (technicalData && Object.keys(technicalData).length > 0) {
                enhancedMarketData['æŠ€æœ¯æŒ‡æ ‡'] = technicalData;
            }
            
            console.log('æ•´åˆåçš„enhancedMarketData:', enhancedMarketData);
            
            // æ˜¾ç¤ºå¸‚åœºæ•°æ®
            if (Object.keys(enhancedMarketData).length > 0) {
                renderMarketTable(enhancedMarketData);
                marketCard.classList.remove('hidden');
                marketCard.classList.add('fade-in');
            }
            
            // æ˜¾ç¤ºæ–°é—»åˆ—è¡¨
            if (newsData && newsData.length > 0) {
                renderNewsList(newsData);
                newsCard.classList.remove('hidden');
                newsCard.classList.add('fade-in');
            } else {
                // æ²¡æœ‰èµ„è®¯æ•°æ®æ—¶æ¸…ç©ºå†…å®¹å¹¶éšè—èµ„è®¯å¡ç‰‡
                newsList.innerHTML = '';
                newsCard.classList.add('hidden');
            }
            
            // æ˜¾ç¤ºåˆ†ææŠ¥å‘Š
            if (aiContent) {
                reportCard.classList.remove('hidden');
                output.innerHTML = '';
                
                const modelName = item.model === 'deepseek-reasoner' ? 'æ€è€ƒæ¨¡å¼' : 'æ ‡å‡†æ¨¡å¼';
                const modelLabel = `<div class="text-sm text-gray-400 mb-4 pb-2 border-b border-border-color">æ¨¡å‹: ${modelName}</div>`;
                
                // æ·»åŠ å¤ç›˜æ•°æ®æ˜¾ç¤º
                let reviewHtml = '';
                if (reviewData && reviewData.length > 0) {
                    reviewHtml = `<div class="mb-4 p-4 bg-hover-bg rounded-lg">
                        <h4 class="text-md font-bold mb-2">å¤ç›˜æ•°æ®</h4>
                        <table class="w-full text-sm">
                            <thead>
                                <tr class="border-b border-border-color">
                                    <th class="text-left py-2">ç±»å‹</th>
                                    <th class="text-left py-2">ä»·æ ¼</th>
                                    <th class="text-left py-2">æ—¶é—´</th>
                                    <th class="text-left py-2">å‰©ä½™æ•°é‡</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${reviewData.map(record => {
                                    const type = record.type === 'buy' ? 'ä¹°å…¥' : 'å–å‡º';
                                    const remaining = record.remaining || '-';
                                    return `<tr class="border-b border-border-color">
                                        <td class="py-2">${type}</td>
                                        <td class="py-2">${record.price}</td>
                                        <td class="py-2">${record.time}</td>
                                        <td class="py-2">${remaining}</td>
                                    </tr>`;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>`;
                }
                
                // æ„å»ºå®Œæ•´çš„åˆ†æå†…å®¹ï¼ŒåŒ…æ‹¬æŠ•èµ„åˆ†æå’Œæ“ä½œå†³ç­–
                let fullContent = aiContent;
                if (fundDirectorContent) {
                    fullContent += '<h2>æ“ä½œå†³ç­–</h2>' + fundDirectorContent;
                }
                
                // ç›´æ¥æ˜¾ç¤ºå¤„ç†åçš„HTMLä»£ç ï¼Œä¸éœ€è¦å†æ¬¡å¤„ç†
                output.innerHTML = modelLabel + reviewHtml + processFullContent(fullContent);
            }
            
            // æ›´æ–°å½“å‰åˆ†ææ•°æ®ï¼Œç”¨äºå¯¼å‡º
            currentAnalysisData = {
                symbol: item.symbol,
                shares: item.shares,
                sellable_shares: item.sellable_shares || 0,
                cost: item.cost,
                cash: item.cash,
                marketData: enhancedMarketData,
                indexData: indexData,
                newsData: newsData,
                reviewData: reviewData,
                aiContent: aiContent,
                fundDirectorContent: fundDirectorContent
            };
        } else {
            console.error('æœªæ‰¾åˆ°å¯¹åº”çš„å†å²è®°å½•ï¼Œid:', id);
        }
    }
    
    // åˆ é™¤å†å²è®°å½•ï¼ˆé€šè¿‡IDï¼‰
    async function deleteHistoryItemById(id) {
        try {
            const formData = new FormData();
            formData.append('action', 'delete_history');
            formData.append('id', id);
            
            const response = await fetch('backend.php', {
                method: 'POST',
                body: formData
            });
            
            const data = await response.json();
            
            if (data.success) {
                console.log('åˆ é™¤æˆåŠŸ');
            } else {
                alert('åˆ é™¤å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'));
            }
        } catch (error) {
            console.error('åˆ é™¤å†å²è®°å½•å¤±è´¥:', error);
            alert('åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•');
        }
    }
    
    // æ¸²æŸ“æ–°é—»åˆ—è¡¨
    function renderNewsList(newsData) {
        console.log('renderNewsListè¢«è°ƒç”¨ï¼Œæ•°æ®:', newsData);
        
        // æ£€æŸ¥æ•°æ®ç±»å‹
        if (!Array.isArray(newsData)) {
            console.error('æ–°é—»æ•°æ®ç±»å‹é”™è¯¯:', newsData);
            newsList.innerHTML = `<div class="text-red-500">æ–°é—»æ•°æ®ç±»å‹é”™è¯¯</div>`;
            return;
        }
        
        if (newsData.length === 0) {
            newsList.innerHTML = `<div class="text-gray-400 text-center py-8">æš‚æ— æ–°é—»æ•°æ®</div>`;
            return;
        }
        
        let html = '';
        newsData.forEach(news => {
            html += `
                <div class="border-b border-border-color pb-4 mb-4 hover:bg-hover-bg p-3 rounded transition-colors">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <a href="${news.url}" target="_blank" class="text-blue-400 hover:underline">${news.title}</a>
                        </div>
                        <div class="text-xs text-gray-400 ml-4">
                            ${news.time}
                        </div>
                    </div>
                </div>
            `;
        });
        
        newsList.innerHTML = html;
    }

    // ä¿å­˜æ¨¡å‹é€‰æ‹©åˆ°å­˜å‚¨
    function saveModelSelection(model) {
        setStorage('deepseekModel', model, 365);
    }
    
    // ä»å­˜å‚¨åŠ è½½æ¨¡å‹é€‰æ‹©
    function loadModelSelection() {
        const savedModel = getStorage('deepseekModel');
        return savedModel || 'deepseek-chat';
    }
    
    // å­˜å‚¨ç³»ç»Ÿè®¾ç½®ï¼ˆåŒ…æ‹¬æ¨¡å‹è´¹ç”¨ï¼‰
    let systemSettings = {
        analysis_cost_chat: 1,
        analysis_cost_reasoner: 2
    };
    
    // åŠ è½½ç³»ç»Ÿåç§°å’Œæ¨¡å‹è´¹ç”¨
    async function loadSystemSettings() {
        try {
            const response = await fetch('backend.php?action=get_system_settings');
            const data = await response.json();
            
            if (data.system_name) {
                document.querySelector('h1').innerHTML = `ğŸ“Š ${data.system_name}`;
                document.title = `${data.system_name} - åŸºäºDeepSeekçš„AIè‚¡ç¥¨åˆ†æ`;
            }
            
            if (data.analysis_cost_chat !== undefined) {
                systemSettings.analysis_cost_chat = parseInt(data.analysis_cost_chat);
            }
            if (data.analysis_cost_reasoner !== undefined) {
                systemSettings.analysis_cost_reasoner = parseInt(data.analysis_cost_reasoner);
            }
            
            updateModelCostDisplay();
        } catch (error) {
            console.error('åŠ è½½ç³»ç»Ÿè®¾ç½®å¤±è´¥:', error);
        }
    }
    
    // æ›´æ–°æ¨¡å‹è´¹ç”¨æ˜¾ç¤º
    function updateModelCostDisplay() {
        const modelSelect = document.getElementById('modelSelect');
        const currentModel = modelSelect.value;
        const cost = currentModel === 'deepseek-reasoner' ? systemSettings.analysis_cost_reasoner : systemSettings.analysis_cost_chat;
        
        const modelLabel = document.querySelector('#modelSelect').parentElement;
        let costSpan = modelLabel.querySelector('.model-cost');
        
        if (!costSpan) {
            costSpan = document.createElement('span');
            costSpan.className = 'model-cost text-xs text-gray-400 ml-2';
            modelLabel.appendChild(costSpan);
        }
        
        costSpan.textContent = `(æ¶ˆè€— ${cost} ç§¯åˆ†)`;
    }
    
    // æ¨¡å‹é€‰æ‹©å˜åŒ–äº‹ä»¶
    document.getElementById('modelSelect').addEventListener('change', updateModelCostDisplay);
    
    // é¡µé¢åŠ è½½æ—¶ä»å­˜å‚¨è¯»å–æ¨¡å‹é€‰æ‹©å’Œå†å²è®°å½•
    window.onload = async function() {
        // åŠ è½½ç³»ç»Ÿè®¾ç½®ï¼ˆåŒ…æ‹¬åç§°å’Œæ¨¡å‹è´¹ç”¨ï¼‰
        await loadSystemSettings();
        
        // åŠ è½½ä¿å­˜çš„ä¸»é¢˜
        loadTheme();
        
        // åŠ è½½æ¨¡å‹é€‰æ‹©
        const savedModel = loadModelSelection();
        modelSelect.value = savedModel;
        hiddenModelInput.value = savedModel;
        
        // æ›´æ–°æ¨¡å‹è´¹ç”¨æ˜¾ç¤º
        updateModelCostDisplay();
        
        // æ£€æŸ¥ç”¨æˆ·ç™»å½•çŠ¶æ€
        await checkLoginStatus();
        
        // åˆ·æ–°ç”¨æˆ·ä¿¡æ¯
        await refreshUserInfo();
        
        // æ£€æŸ¥URLå‚æ•°ï¼Œå¦‚æœæœ‰codeå‚æ•°åˆ™è‡ªåŠ¨å¡«å……è‚¡ç¥¨ä»£ç 
        const urlParams = new URLSearchParams(window.location.search);
        const stockCode = urlParams.get('code');
        if (stockCode) {
            document.getElementById('symbol').value = stockCode;
        }
    };
    
    // æ£€æŸ¥ç”¨æˆ·ç™»å½•çŠ¶æ€
    async function checkLoginStatus() {
        try {
            const response = await fetch('login.php?action=checklogin');
            const data = await response.json();
            
            if (data.logged) {
                updateUserInfo(data.user);
                showFunctionality();
                // ç™»å½•åæ¸²æŸ“å†å²è®°å½•
                await renderHistoryList();
            } else {
                showLoginBtn();
                hideFunctionality();
            }
        } catch (error) {
            console.error('æ£€æŸ¥ç™»å½•çŠ¶æ€å¤±è´¥:', error);
            showLoginBtn();
            hideFunctionality();
        }
    }
    
    // æ›´æ–°ç”¨æˆ·ä¿¡æ¯
    function updateUserInfo(user) {
        document.getElementById('loginBtn').classList.add('hidden');
        document.getElementById('userPoints').classList.remove('hidden');
        document.getElementById('userDropdown').classList.remove('hidden');
        document.getElementById('pointsValue').textContent = user.points;
        document.getElementById('userName').textContent = user.nickname || 'ç”¨æˆ·';
    }
    
    // åˆ·æ–°ç”¨æˆ·ä¿¡æ¯
    async function refreshUserInfo() {
        try {
            const response = await fetch('backend.php?action=refresh_user');
            const data = await response.json();
            if (data.success && data.user) {
                updateUserInfo(data.user);
                console.log('ç”¨æˆ·ä¿¡æ¯å·²åˆ·æ–°:', data.user);
            }
        } catch (error) {
            console.error('åˆ·æ–°ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', error);
        }
    }
    
    // æ˜¾ç¤ºç™»å½•æŒ‰é’®
    function showLoginBtn() {
        document.getElementById('loginBtn').classList.remove('hidden');
        document.getElementById('userPoints').classList.add('hidden');
        document.getElementById('userDropdown').classList.add('hidden');
    }
    
    // æ˜¾ç¤ºåŠŸèƒ½å†…å®¹
    function showFunctionality() {
        document.getElementById('functionalityContainer').classList.remove('hidden');
        document.getElementById('loginPrompt').classList.add('hidden');
        document.getElementById('exportBtn').classList.remove('hidden');
        document.querySelector('#modelSelect').parentElement.classList.remove('hidden');
    }
    
    // éšè—åŠŸèƒ½å†…å®¹
    function hideFunctionality() {
        document.getElementById('functionalityContainer').classList.add('hidden');
        document.getElementById('loginPrompt').classList.remove('hidden');
        document.getElementById('exportBtn').classList.add('hidden');
        document.querySelector('#modelSelect').parentElement.classList.add('hidden');
        
        // éšè—æ‰€æœ‰å¡ç‰‡
        document.getElementById('marketDataCard').classList.add('hidden');
        document.getElementById('newsCard').classList.add('hidden');
        document.getElementById('reportCard').classList.add('hidden');
    }
    
    // ç™»å½•æŒ‰é’®ç‚¹å‡»äº‹ä»¶
    document.getElementById('loginBtn').addEventListener('click', function() {
        document.getElementById('loginModal').classList.remove('hidden');
    });
    
    // ç™»å½•æç¤ºæŒ‰é’®ç‚¹å‡»äº‹ä»¶
    document.getElementById('loginPromptBtn').addEventListener('click', function() {
        document.getElementById('loginModal').classList.remove('hidden');
    });
    
    // å…³é—­ç™»å½•æ¨¡æ€æ¡†
    document.getElementById('closeLoginBtn').addEventListener('click', function() {
        document.getElementById('loginModal').classList.add('hidden');
    });
    
    // ç‚¹å‡»ç™»å½•æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
    document.getElementById('loginModal').addEventListener('click', function(e) {
        if (e.target === document.getElementById('loginModal')) {
            document.getElementById('loginModal').classList.add('hidden');
        }
    });
    
    // åˆ‡æ¢åˆ°æ³¨å†Œé¡µé¢
    document.getElementById('switchToRegisterBtn').addEventListener('click', function() {
        document.getElementById('loginModal').classList.add('hidden');
        document.getElementById('registerModal').classList.remove('hidden');
    });
    
    // å…³é—­æ³¨å†Œæ¨¡æ€æ¡†
    document.getElementById('closeRegisterBtn').addEventListener('click', function() {
        document.getElementById('registerModal').classList.add('hidden');
    });
    
    // ç‚¹å‡»æ³¨å†Œæ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
    document.getElementById('registerModal').addEventListener('click', function(e) {
        if (e.target === document.getElementById('registerModal')) {
            document.getElementById('registerModal').classList.add('hidden');
        }
    });
    
    // åˆ‡æ¢åˆ°ç™»å½•é¡µé¢
    document.getElementById('switchToLoginBtn').addEventListener('click', function() {
        document.getElementById('registerModal').classList.add('hidden');
        document.getElementById('loginModal').classList.remove('hidden');
    });
    
    // ç™»å½•è¡¨å•å›è½¦äº‹ä»¶
    document.getElementById('loginUsername').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            document.getElementById('submitLoginBtn').click();
        }
    });
    
    document.getElementById('loginPassword').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            document.getElementById('submitLoginBtn').click();
        }
    });
    
    // æäº¤ç™»å½•è¡¨å•
    async function submitLogin() {
        const username = document.getElementById('loginUsername').value.trim();
        const password = document.getElementById('loginPassword').value.trim();
        
        if (!username || !password) {
            alert('ç”¨æˆ·åå’Œå¯†ç ä¸èƒ½ä¸ºç©º');
            return;
        }
        
        const loginBtn = document.getElementById('submitLoginBtn');
        const originalText = loginBtn.innerText;
        loginBtn.disabled = true;
        loginBtn.innerText = 'ç™»å½•ä¸­...';
        
        try {
            const response = await fetch('login.php?action=login', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: `username=${encodeURIComponent(username)}&password=${encodeURIComponent(password)}`
            });
            
            const data = await response.json();
            
            if (data.success) {
                alert('ç™»å½•æˆåŠŸ');
                document.getElementById('loginModal').classList.add('hidden');
                checkLoginStatus();
            } else {
                alert(data.message || 'ç™»å½•å¤±è´¥');
            }
        } catch (error) {
            console.error('ç™»å½•å¤±è´¥:', error);
            alert('ç™»å½•å¤±è´¥ï¼Œè¯·é‡è¯•');
        } finally {
            loginBtn.disabled = false;
            loginBtn.innerText = originalText;
        }
    }
    
    document.getElementById('submitLoginBtn').addEventListener('click', submitLogin);
    
    // æ³¨å†Œè¡¨å•å›è½¦äº‹ä»¶
    document.getElementById('registerUsername').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            document.getElementById('submitRegisterBtn').click();
        }
    });
    
    document.getElementById('registerPassword').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            document.getElementById('submitRegisterBtn').click();
        }
    });
    
    document.getElementById('registerNickname').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            document.getElementById('submitRegisterBtn').click();
        }
    });
    
    // æäº¤æ³¨å†Œè¡¨å•
    async function submitRegister() {
        const username = document.getElementById('registerUsername').value.trim();
        const password = document.getElementById('registerPassword').value.trim();
        const nickname = document.getElementById('registerNickname').value.trim();
        
        if (!username || !password) {
            alert('ç”¨æˆ·åå’Œå¯†ç ä¸èƒ½ä¸ºç©º');
            return;
        }
        
        const registerBtn = document.getElementById('submitRegisterBtn');
        const originalText = registerBtn.innerText;
        registerBtn.disabled = true;
        registerBtn.innerText = 'æ³¨å†Œä¸­...';
        
        try {
            const response = await fetch('login.php?action=register', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: `username=${encodeURIComponent(username)}&password=${encodeURIComponent(password)}&nickname=${encodeURIComponent(nickname)}`
            });
            
            const data = await response.json();
            
            if (data.success) {
                alert('æ³¨å†ŒæˆåŠŸ');
                document.getElementById('registerModal').classList.add('hidden');
                checkLoginStatus();
            } else {
                alert(data.message || 'æ³¨å†Œå¤±è´¥');
            }
        } catch (error) {
            console.error('æ³¨å†Œå¤±è´¥:', error);
            alert('æ³¨å†Œå¤±è´¥ï¼Œè¯·é‡è¯•');
        } finally {
            registerBtn.disabled = false;
            registerBtn.innerText = originalText;
        }
    }
    
    document.getElementById('submitRegisterBtn').addEventListener('click', submitRegister);
    
    // ä¿®æ”¹å¯†ç æŒ‰é’®ç‚¹å‡»äº‹ä»¶
    document.getElementById('changePasswordBtn').addEventListener('click', function() {
        document.getElementById('changePasswordModal').classList.remove('hidden');
    });
    
    // å…³é—­ä¿®æ”¹å¯†ç æ¨¡æ€æ¡†
    document.getElementById('closeChangePasswordBtn').addEventListener('click', function() {
        document.getElementById('changePasswordModal').classList.add('hidden');
    });
    
    // ç‚¹å‡»ä¿®æ”¹å¯†ç æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
    document.getElementById('changePasswordModal').addEventListener('click', function(e) {
        if (e.target === document.getElementById('changePasswordModal')) {
            document.getElementById('changePasswordModal').classList.add('hidden');
        }
    });
    
    // æäº¤ä¿®æ”¹å¯†ç è¡¨å•
    document.getElementById('submitChangePasswordBtn').addEventListener('click', async function() {
        const oldPassword = document.getElementById('oldPassword').value.trim();
        const newPassword = document.getElementById('newPassword').value.trim();
        const confirmPassword = document.getElementById('confirmPassword').value.trim();
        
        if (!oldPassword || !newPassword || !confirmPassword) {
            alert('æ‰€æœ‰å­—æ®µä¸èƒ½ä¸ºç©º');
            return;
        }
        
        if (newPassword !== confirmPassword) {
            alert('ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´');
            return;
        }
        
        const changePasswordBtn = document.getElementById('submitChangePasswordBtn');
        const originalText = changePasswordBtn.innerText;
        changePasswordBtn.disabled = true;
        changePasswordBtn.innerText = 'ä¿®æ”¹ä¸­...';
        
        try {
            const response = await fetch('login.php?action=changepassword', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: `old_password=${encodeURIComponent(oldPassword)}&new_password=${encodeURIComponent(newPassword)}&confirm_password=${encodeURIComponent(confirmPassword)}`
            });
            
            const data = await response.json();
            
            if (data.success) {
                alert('å¯†ç ä¿®æ”¹æˆåŠŸ');
                document.getElementById('changePasswordModal').classList.add('hidden');
            } else {
                alert(data.message || 'å¯†ç ä¿®æ”¹å¤±è´¥');
            }
        } catch (error) {
            console.error('å¯†ç ä¿®æ”¹å¤±è´¥:', error);
            alert('å¯†ç ä¿®æ”¹å¤±è´¥ï¼Œè¯·é‡è¯•');
        } finally {
            changePasswordBtn.disabled = false;
            changePasswordBtn.innerText = originalText;
        }
    });
    
    // ä¿®æ”¹ç”¨æˆ·ä¿¡æ¯æŒ‰é’®ç‚¹å‡»äº‹ä»¶
    document.getElementById('updateUserBtn').addEventListener('click', async function() {
        // ä»æœåŠ¡å™¨è·å–å®Œæ•´ç”¨æˆ·ä¿¡æ¯ï¼Œç¡®ä¿è·å–åˆ°æ­£ç¡®çš„ç”¨æˆ·å
        try {
            const response = await fetch('login.php?action=checklogin');
            const data = await response.json();
            
            if (data.logged && data.user) {
                const user = data.user;
                document.getElementById('updateUsername').value = user.username || '';
                document.getElementById('updateNickname').value = user.nickname || user.username || '';
            }
        } catch (error) {
            console.error('è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', error);
            // é™çº§å¤„ç†
            const userName = document.getElementById('userName').textContent;
            document.getElementById('updateUsername').value = userName;
            document.getElementById('updateNickname').value = userName;
        }
        document.getElementById('updateUserModal').classList.remove('hidden');
    });
    
    // å…³é—­ä¿®æ”¹ç”¨æˆ·ä¿¡æ¯æ¨¡æ€æ¡†
    document.getElementById('closeUpdateUserBtn').addEventListener('click', function() {
        document.getElementById('updateUserModal').classList.add('hidden');
    });
    
    // ç‚¹å‡»ä¿®æ”¹ç”¨æˆ·ä¿¡æ¯æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
    document.getElementById('updateUserModal').addEventListener('click', function(e) {
        if (e.target === document.getElementById('updateUserModal')) {
            document.getElementById('updateUserModal').classList.add('hidden');
        }
    });
    
    // æäº¤ä¿®æ”¹ç”¨æˆ·ä¿¡æ¯è¡¨å•
    document.getElementById('submitUpdateUserBtn').addEventListener('click', async function() {
        const username = document.getElementById('updateUsername').value.trim();
        const nickname = document.getElementById('updateNickname').value.trim();
        
        if (!username) {
            alert('ç”¨æˆ·åä¸èƒ½ä¸ºç©º');
            return;
        }
        
        if (!nickname) {
            alert('æ˜µç§°ä¸èƒ½ä¸ºç©º');
            return;
        }
        
        const updateUserBtn = document.getElementById('submitUpdateUserBtn');
        const originalText = updateUserBtn.innerText;
        updateUserBtn.disabled = true;
        updateUserBtn.innerText = 'æ›´æ–°ä¸­...';
        
        try {
            const response = await fetch('login.php?action=updateuser', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: `username=${encodeURIComponent(username)}&nickname=${encodeURIComponent(nickname)}`
            });
            
            const data = await response.json();
            
            if (data.success) {
                alert('ç”¨æˆ·ä¿¡æ¯æ›´æ–°æˆåŠŸ');
                document.getElementById('updateUserModal').classList.add('hidden');
                checkLoginStatus();
            } else {
                alert(data.message || 'ç”¨æˆ·ä¿¡æ¯æ›´æ–°å¤±è´¥');
            }
        } catch (error) {
            console.error('ç”¨æˆ·ä¿¡æ¯æ›´æ–°å¤±è´¥:', error);
            alert('ç”¨æˆ·ä¿¡æ¯æ›´æ–°å¤±è´¥ï¼Œè¯·é‡è¯•');
        } finally {
            updateUserBtn.disabled = false;
            updateUserBtn.innerText = originalText;
        }
    });
    
    // ç”¨æˆ·èœå•æŒ‰é’®ç‚¹å‡»äº‹ä»¶
    document.getElementById('userMenuBtn').addEventListener('click', function() {
        const userMenu = document.getElementById('userMenu');
        userMenu.classList.toggle('hidden');
    });
    
    // ç‚¹å‡»é¡µé¢å…¶ä»–åœ°æ–¹å…³é—­ç”¨æˆ·èœå•
    document.addEventListener('click', function(e) {
        const userMenu = document.getElementById('userMenu');
        const userMenuBtn = document.getElementById('userMenuBtn');
        if (!userMenu.contains(e.target) && !userMenuBtn.contains(e.target)) {
            userMenu.classList.add('hidden');
        }
    });
    
    // å……å€¼æŒ‰é’®ç‚¹å‡»äº‹ä»¶
    document.getElementById('rechargeBtn').addEventListener('click', async function() {
        await refreshUserInfo();
        window.location.href = 'recharge.html';
    });
    
    // ç§¯åˆ†å†å²æŒ‰é’®ç‚¹å‡»äº‹ä»¶
    document.getElementById('pointsHistoryBtn').addEventListener('click', async function() {
        await refreshUserInfo();
        window.location.href = 'points_history.html';
    });
    
    // é¾™å¤´è‚¡æ¨èæŒ‰é’®ç‚¹å‡»äº‹ä»¶
    document.getElementById('dragonStocksBtn').addEventListener('click', async function() {
        await refreshUserInfo();
        window.location.href = 'dragon.html';
    });
    
    // åˆ·æ–°ç§¯åˆ†æŒ‰é’®ç‚¹å‡»äº‹ä»¶
    document.getElementById('refreshPointsBtn').addEventListener('click', async function() {
        await refreshUserInfo();
        alert('ç§¯åˆ†å·²åˆ·æ–°ï¼');
    });
    
    
    // é€€å‡ºç™»å½•æŒ‰é’®ç‚¹å‡»äº‹ä»¶
    document.getElementById('logoutBtn').addEventListener('click', function() {
        window.location.href = 'login.php?action=logout';
    });
    
    // ä¿å­˜æ¨¡å‹é€‰æ‹©
    modelSelect.addEventListener('change', function() {
        const selectedModel = this.value;
        saveModelSelection(selectedModel);
        hiddenModelInput.value = selectedModel;
    });
    
    // æ˜¾ç¤ºç§»åŠ¨ç«¯å†å²è®°å½•æ¨¡æ€æ¡†
    mobileHistoryBtn.addEventListener('click', function() {
        // é‡æ–°æ¸²æŸ“å†å²è®°å½•ï¼Œç¡®ä¿æ•°æ®æœ€æ–°
        renderHistoryList();
        mobileHistoryModal.classList.remove('hidden');
    });
    
    // éšè—ç§»åŠ¨ç«¯å†å²è®°å½•æ¨¡æ€æ¡†
    closeMobileHistoryBtn.addEventListener('click', function() {
        mobileHistoryModal.classList.add('hidden');
    });
    
    // ç‚¹å‡»ç§»åŠ¨ç«¯å†å²è®°å½•æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
    mobileHistoryModal.addEventListener('click', function(e) {
        if (e.target === mobileHistoryModal) {
            mobileHistoryModal.classList.add('hidden');
        }
    });
    
    // æ˜¾ç¤ºå¯¼å‡ºæ¨¡æ€æ¡†
    exportBtn.addEventListener('click', function() {
        // æ£€æŸ¥æ˜¯å¦æœ‰åˆ†ææ•°æ®æˆ–å†å²æ•°æ®æ˜¾ç¤º
        if (!currentAnalysisData.marketData && !currentAnalysisData.aiContent && 
            marketCard.classList.contains('hidden') && reportCard.classList.contains('hidden')) {
            alert('è¯·å…ˆè¿›è¡Œè‚¡ç¥¨åˆ†ææˆ–æŸ¥çœ‹å†å²æ•°æ®ï¼Œç„¶åå†å¯¼å‡ºæ•°æ®');
            return;
        }
        
        exportModal.classList.remove('hidden');
    });
    
    // éšè—å¯¼å‡ºæ¨¡æ€æ¡†
    closeExportBtn.addEventListener('click', function() {
        exportModal.classList.add('hidden');
    });
    
    // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­å¯¼å‡ºæ¨¡æ€æ¡†
    exportModal.addEventListener('click', function(e) {
        if (e.target === exportModal) {
            exportModal.classList.add('hidden');
        }
    });
    
    // å¼€å§‹å¯¼å‡º - ä¿®å¤ canvas å†…å®¹ä¸¢å¤±çš„é—®é¢˜ï¼
    startExportBtn.addEventListener('click', async function() {
        const exportFormat = document.querySelector('input[name="exportFormat"]:checked').value;
        const exportContent = [];
        document.querySelectorAll('input[name="exportContent"]:checked').forEach(checkbox => {
            exportContent.push(checkbox.value);
        });
        
        if (exportContent.length === 0) {
            alert('è¯·è‡³å°‘é€‰æ‹©ä¸€é¡¹å¯¼å‡ºå†…å®¹');
            return;
        }
        
        let stockName = 'è‚¡ç¥¨';
        if (currentAnalysisData.marketData) {
            stockName = currentAnalysisData.marketData['åç§°'] || stockName;
        }
        
        startExportBtn.disabled = true;
        startExportBtn.innerText = 'å¯¼å‡ºä¸­...';
        
        try {
            // ç¬¬ä¸€æ­¥ï¼šå…ˆä¿å­˜é¡µé¢ä¸Šæ‰€æœ‰åŸå§‹ canvas çš„å›¾ç‰‡æ•°æ®
            const canvasImages = {};
            const originalCanvases = document.querySelectorAll('#marketDataCard canvas');
            
            for (let i = 0; i < originalCanvases.length; i++) {
                const canvas = originalCanvases[i];
                const id = canvas.id || `canvas-${i}`;
                try {
                    canvasImages[id] = canvas.toDataURL('image/png');
                } catch (e) {
                    console.error('æ— æ³•ä¿å­˜ canvas å›¾ç‰‡:', e);
                }
            }
            
            // ç¬¬äºŒæ­¥ï¼šåˆ›å»ºå¯¼å‡ºå®¹å™¨
            const exportContainer = document.createElement('div');
            exportContainer.className = 'bg-card-bg p-6 rounded-lg';
            exportContainer.style.width = '800px';
            exportContainer.style.maxWidth = '100%';
            exportContainer.style.margin = '0 auto';
            
            // æ ‡é¢˜
            const title = document.createElement('h1');
            title.className = 'text-2xl font-bold mb-6 text-center';
            title.textContent = stockName + ' - è‚¡ç¥¨åˆ†ææŠ¥å‘Š';
            exportContainer.appendChild(title);
            
            const exportTime = document.createElement('p');
            exportTime.className = 'text-sm text-gray-500 mb-6 text-center';
            exportTime.textContent = 'å¯¼å‡ºæ—¶é—´: ' + new Date().toLocaleString('zh-CN');
            exportContainer.appendChild(exportTime);
            
            // ç¬¬ä¸‰æ­¥ï¼šå¤åˆ¶å¸‚åœºå¡ç‰‡
            if (exportContent.includes('marketData') && !marketCard.classList.contains('hidden')) {
                const marketClone = marketCard.cloneNode(true);
                marketClone.classList.remove('hidden');
                marketClone.style.marginBottom = '30px';
                exportContainer.appendChild(marketClone);
            }
            
            // å¤åˆ¶æ–°é—»å¡ç‰‡
            if (exportContent.includes('news') && !newsCard.classList.contains('hidden')) {
                const newsClone = newsCard.cloneNode(true);
                newsClone.classList.remove('hidden');
                newsClone.style.marginBottom = '30px';
                exportContainer.appendChild(newsClone);
            }
            
            // å¤åˆ¶åˆ†ææŠ¥å‘Š
            if (exportContent.includes('analysis') && !reportCard.classList.contains('hidden')) {
                const reportClone = reportCard.cloneNode(true);
                reportClone.classList.remove('hidden');
                exportContainer.appendChild(reportClone);
            }
            
            // æ·»åŠ å¤ç›˜æ•°æ®
            if (currentAnalysisData.reviewData && currentAnalysisData.reviewData.length > 0) {
                const reviewSection = document.createElement('div');
                reviewSection.className = 'mb-6 p-6 bg-card-bg border border-border-color rounded-lg';
                
                const reviewTitle = document.createElement('h3');
                reviewTitle.className = 'text-lg font-bold mb-4';
                reviewTitle.textContent = 'å¤ç›˜æ•°æ®';
                reviewSection.appendChild(reviewTitle);
                
                const reviewTable = document.createElement('table');
                reviewTable.className = 'w-full text-sm border-collapse';
                
                const tableHeader = document.createElement('thead');
            tableHeader.innerHTML = `
                <tr class="border-b border-border-color">
                    <th class="text-left py-2 px-4">ç±»å‹</th>
                    <th class="text-left py-2 px-4">ä»·æ ¼</th>
                    <th class="text-left py-2 px-4">æ—¶é—´</th>
                    <th class="text-left py-2 px-4">å‰©ä½™æ•°é‡</th>
                </tr>
            `;
            reviewTable.appendChild(tableHeader);
            
            const tableBody = document.createElement('tbody');
            currentAnalysisData.reviewData.forEach(record => {
                const type = record.type === 'buy' ? 'ä¹°å…¥' : 'å–å‡º';
                const remaining = record.remaining || '-';
                const row = document.createElement('tr');
                row.className = 'border-b border-border-color';
                row.innerHTML = `
                    <td class="py-2 px-4">${type}</td>
                    <td class="py-2 px-4">${record.price}</td>
                    <td class="py-2 px-4">${record.time}</td>
                    <td class="py-2 px-4">${remaining}</td>
                `;
                tableBody.appendChild(row);
            });
                reviewTable.appendChild(tableBody);
                
                reviewSection.appendChild(reviewTable);
                exportContainer.appendChild(reviewSection);
            }
            
            document.body.appendChild(exportContainer);
            
            // ç¬¬å››æ­¥ï¼šæŠŠæ‰€æœ‰ canvas æ›¿æ¢æˆ img æ ‡ç­¾ï¼Œå¹¶ä½¿ç”¨ä¹‹å‰ä¿å­˜çš„å›¾ç‰‡æ•°æ®
            const canvases = exportContainer.querySelectorAll('canvas');
            for (let i = 0; i < canvases.length; i++) {
                const canvas = canvases[i];
                const id = canvas.id || `canvas-${i}`;
                const img = document.createElement('img');
                
                // ä½¿ç”¨ä¹‹å‰ä¿å­˜çš„å›¾ç‰‡æ•°æ®
                if (canvasImages[id]) {
                    img.src = canvasImages[id];
                } else {
                    // å¦‚æœæ²¡æœ‰ä¿å­˜åˆ°ï¼Œå°è¯•ç›´æ¥ä»å½“å‰ canvas è·å–ï¼ˆè™½ç„¶ clone åå¯èƒ½æ˜¯ç©ºçš„ï¼‰
                    try {
                        img.src = canvas.toDataURL('image/png');
                    } catch (e) {
                        console.error('æ— æ³•è·å– canvas æ•°æ®:', e);
                    }
                }
                
                img.style.maxWidth = '100%';
                img.style.display = 'block';
                img.className = canvas.className || '';
                if (canvas.style.height) img.style.height = canvas.style.height;
                if (canvas.style.maxHeight) img.style.maxHeight = canvas.style.maxHeight;
                canvas.parentNode.replaceChild(img, canvas);
            }
            
            await new Promise(resolve => setTimeout(resolve, 500));
            
            if (exportFormat === 'pdf') {
                await exportToPdf(exportContainer, stockName);
            } else {
                await exportToImage(exportContainer, stockName);
            }
            
            document.body.removeChild(exportContainer);
            exportModal.classList.add('hidden');
            alert('å¯¼å‡ºæˆåŠŸ');
        } catch (error) {
            console.error('å¯¼å‡ºå¤±è´¥:', error);
            alert('å¯¼å‡ºå¤±è´¥: ' + error.message);
        } finally {
            startExportBtn.disabled = false;
            startExportBtn.innerText = 'å¼€å§‹å¯¼å‡º';
        }
    });
    
    // æ£€æµ‹æ˜¯å¦æ˜¯å¾®ä¿¡æµè§ˆå™¨
    function isWeChat() {
        const ua = navigator.userAgent.toLowerCase();
        return ua.indexOf('micromessenger') !== -1;
    }
    
    // å¯¼å‡ºä¸ºPDF
    async function exportToPdf(element, stockName) {
        const { jsPDF } = window.jspdf;
        let safeStockName = 'è‚¡ç¥¨';
        if (stockName && typeof stockName === 'string') {
            safeStockName = stockName.replace(/[\\/:*?"<>|]/g, '_');
        }
        
        // ç”Ÿæˆå›¾ç‰‡ - ä½¿ç”¨æ›´å¥½çš„é…ç½®ç¡®ä¿å›¾è¡¨æ•è·
        const canvas = await html2canvas(element, {
            scale: 2,
            useCORS: true,
            logging: false,
            scrollY: 0,
            scrollX: 0,
            windowWidth: element.scrollWidth,
            windowHeight: element.scrollHeight,
            backgroundColor: '#ffffff',
            allowTaint: true,
            imageTimeout: 15000
        });
        
        const imgData = canvas.toDataURL('image/png');
        
        if (isWeChat()) {
            showWeChatDownloadHelp(imgData, safeStockName + ' - è‚¡ç¥¨åˆ†ææŠ¥å‘Š.png');
            return;
        }
        
        const imgWidth = 210;
        const pageHeight = 295;
        const imgHeight = canvas.height * imgWidth / canvas.width;
        
        // åˆ›å»ºPDFæ–‡æ¡£
        const pdf = new jsPDF('p', 'mm', 'a4');
        
        // ç®€å•å¯é çš„åˆ†é¡µæ–¹å¼ï¼šé€é¡µæ˜¾ç¤ºï¼Œæ¯é¡µåªæ˜¾ç¤ºå¯¹åº”éƒ¨åˆ†
        let position = 0;
        let heightLeft = imgHeight;
        
        // ç¬¬ä¸€é¡µ
        pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
        heightLeft -= pageHeight;
        
        // åç»­é¡µé¢
        while (heightLeft > 0) {
            position = position - pageHeight;
            pdf.addPage();
            pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
            heightLeft -= pageHeight;
        }
        
        // ä¿å­˜PDF
        pdf.save(safeStockName + ' - è‚¡ç¥¨åˆ†ææŠ¥å‘Š.pdf');
    }
    
    // å¯¼å‡ºä¸ºå›¾ç‰‡
    async function exportToImage(element, stockName) {
        let safeStockName = 'è‚¡ç¥¨';
        if (stockName && typeof stockName === 'string') {
            safeStockName = stockName.replace(/[\\/:*?"<>|]/g, '_');
        }
        
        // ç”Ÿæˆå›¾ç‰‡
        const canvas = await html2canvas(element, {
            scale: 2,
            useCORS: true,
            logging: false
        });
        
        const imgData = canvas.toDataURL('image/png');
        
        if (isWeChat()) {
            showWeChatDownloadHelp(imgData, safeStockName + ' - è‚¡ç¥¨åˆ†ææŠ¥å‘Š.png');
            return;
        }
        
        // åˆ›å»ºä¸‹è½½é“¾æ¥
        const link = document.createElement('a');
        link.download = safeStockName + ' - è‚¡ç¥¨åˆ†ææŠ¥å‘Š.png';
        link.href = imgData;
        link.click();
    }
    
    // æ˜¾ç¤ºå¾®ä¿¡æµè§ˆå™¨ä¸‹è½½å¸®åŠ©
    function showWeChatDownloadHelp(imgData, fileName) {
        // åˆ›å»ºä¸€ä¸ªæ¨¡æ€æ¡†æ˜¾ç¤ºå›¾ç‰‡å’Œæç¤º
        const modal = document.createElement('div');
        modal.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.9);
            z-index: 99999;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
        `;
        
        modal.innerHTML = `
            <div style="max-width: 100%; max-height: 70vh; overflow: auto; margin-bottom: 20px;">
                <img src="${imgData}" style="max-width: 100%; display: block;">
            </div>
            <div style="background: white; padding: 20px; border-radius: 8px; max-width: 400px; width: 100%; text-align: center;">
                <h3 style="margin: 0 0 15px 0; color: #333;">å¾®ä¿¡æµè§ˆå™¨æç¤º</h3>
                <p style="color: #666; margin-bottom: 15px; line-height: 1.6;">
                    å¾®ä¿¡æµè§ˆå™¨ä¸æ”¯æŒç›´æ¥ä¸‹è½½ï¼Œè¯·é•¿æŒ‰ä¸Šæ–¹å›¾ç‰‡<br>
                    é€‰æ‹©"ä¿å­˜åˆ°æ‰‹æœº"å³å¯ä¿å­˜å›¾ç‰‡
                </p>
                <p style="color: #999; font-size: 12px; margin-bottom: 15px;">
                    å¦‚æœéœ€è¦PDFæ ¼å¼ï¼Œè¯·åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€
                </p>
                <button id="closeWechatHelp" style="background: #238636; color: white; border: none; padding: 10px 30px; border-radius: 6px; font-size: 16px; cursor: pointer;">
                    æˆ‘çŸ¥é“äº†
                </button>
            </div>
        `;
        
        document.body.appendChild(modal);
        
        document.getElementById('closeWechatHelp').onclick = function() {
            document.body.removeChild(modal);
        };
    }
    


    form.onsubmit = async (e) => {
        e.preventDefault();
        
        // é‡ç½® UI
        submitBtn.disabled = true;
        submitBtn.innerText = "æ•°æ®è·å–ä¸­...";
        marketCard.classList.add('hidden');
        newsCard.classList.add('hidden');
        reportCard.classList.remove('hidden');
        output.innerHTML = `<div class="text-blue-400 animate-pulse">æ­£åœ¨è§£æè…¾è®¯è¡Œæƒ…æ¥å£æ•°æ®å¹¶åŒæ­¥è‡³ DeepSeek AI...</div>`;
        
        // æ¸…ç©ºæ—§æ•°æ®
        newsList.innerHTML = '';
        fullDataTable.innerHTML = '';
        
        // æ˜¾ç¤ºè¿›åº¦æ¡
        progressBarContainer.classList.remove('hidden');
        updateProgress(0, 'å‡†å¤‡å¼€å§‹...');

        const formData = new FormData(form);
        
        // æ”¶é›†è¡¨å•æ•°æ®
    const symbol = formData.get('symbol');
    const shares = formData.get('shares');
    const sellable_shares = formData.get('sellable_shares');
    const cost = formData.get('cost');
    const cash = formData.get('cash');

    // æ”¶é›†é€‰ä¸­çš„æˆ˜æ³•ä¿¡æ¯
    const strategies = [];
    document.querySelectorAll('input[name="strategies[]"]:checked').forEach(checkbox => {
        strategies.push(checkbox.value);
    });

    // æ”¶é›†å¤ç›˜æ•°æ®
    const reviewData = [];
    const reviewRecords = document.querySelectorAll('.review-record');
    reviewRecords.forEach((record, index) => {
        const type = record.querySelector(`select[name^="review_type_"]`).value;
        const price = record.querySelector(`input[name^="review_price_"]`).value;
        const amount = record.querySelector(`input[name^="review_amount_"]`).value;
        const time = record.querySelector(`input[name^="review_time_"]`).value;
        const remaining = record.querySelector(`input[name^="review_remaining_"]`).value;
        
        if (type && price && amount && time) {
            reviewData.push({
                type: type,
                price: price,
                amount: amount,
                time: time,
                remaining: remaining
            });
        }
    });

    // å°†æˆ˜æ³•ä¿¡æ¯æ·»åŠ åˆ°formDataä¸­
    if (strategies.length > 0) {
        formData.append('strategies', JSON.stringify(strategies));
    } else {
        formData.append('strategies', JSON.stringify([]));
    }

        // é‡ç½®å½“å‰åˆ†ææ•°æ®
        currentAnalysisData = {
            id: null,
            symbol: symbol,
            shares: shares,
            sellable_shares: sellable_shares,
            cost: cost,
            cash: cash,
            reviewData: reviewData.length > 0 ? reviewData : null,
            timestamp: new Date().toLocaleString('zh-CN'),
            marketData: null,
            aiContent: ''
        };

        // å°†å¤ç›˜æ•°æ®æ·»åŠ åˆ°formDataä¸­
        if (reviewData.length > 0) {
            formData.append('reviewData', JSON.stringify(reviewData));
        }

        try {
            // æ£€æŸ¥æ˜¯å¦å¯ç”¨äº†åŸºé‡‘æ€»ç›‘åŠŸèƒ½
            const fundDirectorEnabled = formData.get('fundDirector') !== null;
            
            // å¦‚æœå¯ç”¨äº†åŸºé‡‘æ€»ç›‘åŠŸèƒ½ï¼Œç§»é™¤è¯¥å­—æ®µï¼Œå…ˆè¿›è¡Œç¬¬ä¸€æ¬¡åˆ†æ
            if (fundDirectorEnabled) {
                formData.delete('fundDirector');
            }
            
            const response = await fetch('backend.php', { method: 'POST', body: formData });
            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            
            output.innerHTML = "";
            fullContentBuffer = ''; // é‡ç½®å®Œæ•´å†…å®¹ç¼“å†²åŒº

            while (true) {
                const { value, done } = await reader.read();
                if (done) break;
                
                const chunk = decoder.decode(value);
                const lines = chunk.split('\n');

                for (let line of lines) {
                    if (line.startsWith('PROGRESS:')) {
                        console.log('æ”¶åˆ°PROGRESSè¡Œ:', line);
                        try {
                            const progressData = JSON.parse(line.replace('PROGRESS:', ''));
                            console.log('è§£æåçš„PROGRESSæ•°æ®:', progressData);
                            
                            // æ›´æ–°è¿›åº¦æ¡
                            updateProgress(progressData.percentage, progressData.message);
                            
                            // å¦‚æœéœ€è¦éšè—è¿›åº¦æ¡
                            if (progressData.hide) {
                                setTimeout(() => {
                                    progressBarContainer.classList.add('hidden');
                                }, 1000);
                                // åˆ†æå®Œæˆï¼Œè‡ªåŠ¨åˆ·æ–°ç”¨æˆ·ç§¯åˆ†
                                refreshUserInfo();
                            }
                        } catch (error) {
                            console.error('è§£æPROGRESSæ•°æ®å¤±è´¥:', error);
                            console.error('åŸå§‹PROGRESSè¡Œ:', line);
                        }
                    } else if (line.startsWith('ANALYSIS_ID:')) {
                        const analysisId = line.replace('ANALYSIS_ID:', '');
                        console.log('æ”¶åˆ°åˆ†æID:', analysisId);
                        currentAnalysisData.id = analysisId;
                    } else if (line.startsWith('DATA:')) {
                        console.log('æ”¶åˆ°DATAè¡Œ:', line);
                        try {
                            const data = JSON.parse(line.replace('DATA:', ''));
                            console.log('è§£æåçš„DATAæ•°æ®:', data);
                            
                            // æ£€æŸ¥æ•°æ®ç»“æ„
                            if (data.stockData && typeof data.stockData === 'object') {
                                console.log('ä½¿ç”¨æ–°çš„æ•°æ®ç»“æ„');
                                const stockData = data.stockData;
                                const indexData = data.indexData;
                                
                                // æ¸²æŸ“è‚¡ç¥¨æ•°æ®
                                renderMarketTable(stockData);
                                marketCard.classList.remove('hidden');
                                marketCard.classList.add('fade-in');
                                
                                // ä¿å­˜å¸‚åœºæ•°æ®
                                currentAnalysisData.marketData = stockData;
                                currentAnalysisData.stockName = stockData.åç§°;
                                
                                // ä¿å­˜æŒ‡æ•°æ•°æ®
                                if (indexData) {
                                    currentAnalysisData.indexData = indexData;
                                }
                                
                                // ä¿å­˜æ–°é—»æ•°æ®
                                if (data.newsData && data.newsData.length > 0) {
                                    currentAnalysisData.newsData = data.newsData;
                                    // æ¸²æŸ“æ–°é—»åˆ—è¡¨
                                    renderNewsList(data.newsData);
                                    newsCard.classList.remove('hidden');
                                    newsCard.classList.add('fade-in');
                                }
                            } else {
                                console.log('ä½¿ç”¨æ—§çš„æ•°æ®ç»“æ„');
                                // æ¸²æŸ“è‚¡ç¥¨æ•°æ®
                                renderMarketTable(data);
                                marketCard.classList.remove('hidden');
                                marketCard.classList.add('fade-in');
                                
                                // ä¿å­˜å¸‚åœºæ•°æ®
                                currentAnalysisData.marketData = data;
                                currentAnalysisData.stockName = data.åç§°;
                            }
                        } catch (error) {
                            console.error('è§£æDATAæ•°æ®å¤±è´¥:', error);
                            console.error('åŸå§‹DATAè¡Œ:', line);
                            fullDataTable.innerHTML = `<div class="text-red-500">è§£ææ•°æ®å¤±è´¥: ${error.message}</div>`;
                        }
                    } else if (line.startsWith('TEXT:')) {
                        const text = line.replace('TEXT:', '');
                        if (text) {
                            // å°†æ•°æ®æ·»åŠ åˆ°å®Œæ•´å†…å®¹ç¼“å†²åŒº
                            fullContentBuffer += text;
                            
                            // å®šæœŸæ›´æ–°æ˜¾ç¤º
                            updateStreamDisplay();
                            window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
                        }
                    }
                }
            }
            
            // ä»output.innerHTMLä¸­è·å–å®Œæ•´çš„HTMLä»£ç 
            currentAnalysisData.aiContent = output.innerHTML;
            
            // ä¿å­˜åˆ†ææ•°æ®åˆ°å†å²è®°å½•
            console.log('å‡†å¤‡ä¿å­˜åˆ†ææ•°æ®åˆ°å†å²è®°å½•');
            console.log('currentAnalysisData:', currentAnalysisData);
            console.log('marketDataå­˜åœ¨:', !!currentAnalysisData.marketData);
            console.log('aiContentå­˜åœ¨:', !!currentAnalysisData.aiContent);
            
            if (currentAnalysisData.marketData || currentAnalysisData.aiContent) {
                console.log('è°ƒç”¨saveAnalysisToHistoryå‡½æ•°');
                saveAnalysisToHistory(currentAnalysisData);
            } else {
                console.log('marketDataå’ŒaiContentéƒ½ä¸å­˜åœ¨ï¼Œä¸ä¿å­˜åˆ°å†å²è®°å½•');
            }
            
            // å¦‚æœå¯ç”¨äº†åŸºé‡‘æ€»ç›‘åŠŸèƒ½ï¼Œç°åœ¨æ‰§è¡Œç¬¬äºŒæ¬¡åˆ†æ
            if (fundDirectorEnabled) {
                await executeFundDirectorAnalysis(formData, currentAnalysisData);
            }
        } catch (err) {
            output.innerHTML = `<span class="text-red-500">ç³»ç»Ÿé”™è¯¯: ${err.message}</span>`;
        } finally {
            submitBtn.disabled = false;
            submitBtn.innerText = "å¼€å§‹å®æ—¶æ•°æ®åˆ†æ";
        }
    };
    
    // æ‰§è¡ŒåŸºé‡‘æ€»ç›‘åˆ†æ
    async function executeFundDirectorAnalysis(originalFormData, analysisData) {
        try {
            // æ˜¾ç¤ºè¿›åº¦æ¡
            progressBarContainer.classList.remove('hidden');
            updateProgress(0, 'æ­£åœ¨å¯åŠ¨æ“ä½œå†³ç­–åˆ†æ...');
            
            // æ„å»ºæ–°çš„formDataï¼Œæ·»åŠ åŸºé‡‘æ€»ç›‘åˆ†ææ‰€éœ€çš„æ•°æ®
            const fundDirectorFormData = new FormData();
            
            // æ·»åŠ åŸºæœ¬å‚æ•°
            fundDirectorFormData.append('action', 'fund_director_analysis');
            fundDirectorFormData.append('apiKey', originalFormData.get('apiKey'));
            fundDirectorFormData.append('model', 'deepseek-reasoner'); // åŸºé‡‘æ€»ç›‘åˆ†æä½¿ç”¨æ€è€ƒæ¨¡å¼
            fundDirectorFormData.append('symbol', analysisData.symbol);
            fundDirectorFormData.append('shares', analysisData.shares);
            fundDirectorFormData.append('cost', analysisData.cost);
            fundDirectorFormData.append('cash', analysisData.cash);
            
            // æ·»åŠ åˆ†æIDï¼Œç”¨äºæ›´æ–°ç°æœ‰è®°å½•
            if (analysisData.id) {
                fundDirectorFormData.append('analysisId', analysisData.id);
            }
            
            // æ·»åŠ å¸‚åœºæ•°æ®
            if (analysisData.marketData) {
                fundDirectorFormData.append('marketData', JSON.stringify(analysisData.marketData));
            }
            
            // æ·»åŠ AIåˆ†æç»“æœ
            if (analysisData.aiContent) {
                fundDirectorFormData.append('aiResult', analysisData.aiContent);
            }
            
            // å‘é€åŸºé‡‘æ€»ç›‘åˆ†æè¯·æ±‚
            const response = await fetch('backend.php', { method: 'POST', body: fundDirectorFormData });
            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            
            // ç”¨äºç´¯ç§¯AIè¿”å›çš„å†…å®¹
            let fundDirectorContent = '';

            while (true) {
                const { value, done } = await reader.read();
                if (done) break;
                
                const chunk = decoder.decode(value);
                const lines = chunk.split('\n');

                for (let line of lines) {
                    if (line.startsWith('PROGRESS:')) {
                        try {
                            const progressData = JSON.parse(line.replace('PROGRESS:', ''));
                            updateProgress(progressData.percentage, progressData.message);
                            
                            if (progressData.hide) {
                                // å»¶é•¿å»¶è¿Ÿæ—¶é—´ï¼Œç¡®ä¿æ‰€æœ‰å†…å®¹éƒ½å·²æ˜¾ç¤º
                                setTimeout(() => {
                                    progressBarContainer.classList.add('hidden');
                                }, 3000);
                                // åˆ†æå®Œæˆï¼Œè‡ªåŠ¨åˆ·æ–°ç”¨æˆ·ç§¯åˆ†
                                refreshUserInfo();
                            }
                        } catch (error) {
                            console.error('è§£æPROGRESSæ•°æ®å¤±è´¥:', error);
                        }
                    } else if (line.startsWith('TEXT:')) {
                        const text = line.replace('TEXT:', '');
                        if (text) {
                            fundDirectorContent += text;
                            // å¤„ç†HTMLå†…å®¹å¹¶æ˜¾ç¤º
                            const processedContent = processFullContent(fundDirectorContent);
                            if (output.innerHTML.includes('<h2>æ“ä½œå†³ç­–</h2>')) {
                                output.innerHTML = output.innerHTML.replace(/<h2>æ“ä½œå†³ç­–<\/h2>.*$/, '<h2>æ“ä½œå†³ç­–</h2>' + processedContent);
                            } else {
                                output.innerHTML += '<h2>æ“ä½œå†³ç­–</h2>' + processedContent;
                            }
                            window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
                        }
                    }
                }
            }
            
            // æ›´æ–°å½“å‰åˆ†ææ•°æ®
            currentAnalysisData.aiContent = output.innerHTML;
            
        } catch (err) {
            output.innerHTML += `<span class="text-red-500">æ“ä½œå†³ç­–åˆ†æé”™è¯¯: ${err.message}</span>`;
        }
    };



    function updateStreamDisplay() {
        // è·å–å½“å‰é€‰æ‹©çš„æ¨¡å‹
        const currentModel = document.getElementById('modelSelect').value;
        const modelName = currentModel === 'deepseek-reasoner' ? 'æ€è€ƒæ¨¡å¼' : 'æ ‡å‡†æ¨¡å¼';
        const modelLabel = `<div class="text-sm text-gray-400 mb-4 pb-2 border-b border-border-color">æ¨¡å‹: ${modelName}</div>`;
        
        // ä½¿ç”¨å®Œæ•´ç¼“å†²åŒºçš„å†…å®¹æ¥æ›´æ–°æ˜¾ç¤ºï¼Œå¹¶åœ¨å¼€å¤´æ·»åŠ æ¨¡å‹æ ‡æ³¨
        output.innerHTML = modelLabel + processFullContent(fullContentBuffer);
    }

    function processFullContent(fullText) {
        // å¤„ç†å®Œæ•´çš„HTMLå†…å®¹ï¼Œç¡®ä¿æ­£ç¡®æ¸²æŸ“
        let cleanHtml = fullText;
        
        // åœ¨åˆ†ææŠ¥å‘Šå¼€å¤´æ·»åŠ å…è´£å£°æ˜
        const disclaimer = '<div style="background: var(--hover-bg); border: 1px solid var(--border-color); border-radius: 8px; padding: 12px; margin-bottom: 20px; font-size: 12px; color: var(--gray-400);"><div style="color: #f59e0b; font-weight: bold; margin-bottom: 8px;">âš ï¸ é‡è¦æç¤º</div><div>æœ¬åˆ†ææŠ¥å‘Šä»…ä¾›å­¦ä¹ ã€ç ”ç©¶å’Œå‚è€ƒä½¿ç”¨ï¼Œä¸æ„æˆä»»ä½•æŠ•èµ„å»ºè®®æˆ–äº¤æ˜“æŒ‡å¯¼ã€‚è‚¡ç¥¨ã€åŸºé‡‘ç­‰é‡‘èäº§å“æŠ•èµ„å­˜åœ¨é£é™©ï¼Œè¯·è°¨æ…å†³ç­–ï¼Œè‡ªè¡Œæ‰¿æ‹…æŠ•èµ„é£é™©ã€‚</div></div>';
        
        // 1. é¦–å…ˆå¤„ç†è½¬ä¹‰çš„HTMLæ ‡ç­¾ï¼Œè¿™æ˜¯æœ€å…³é”®çš„ä¸€æ­¥
        cleanHtml = cleanHtml.replace(/&lt;/g, '<');
        cleanHtml = cleanHtml.replace(/&gt;/g, '>');
        cleanHtml = cleanHtml.replace(/&amp;/g, '&');
        // å¤„ç†å¯èƒ½çš„å…¶ä»–è½¬ä¹‰å­—ç¬¦
        cleanHtml = cleanHtml.replace(/&quot;/g, '"');
        cleanHtml = cleanHtml.replace(/&#39;/g, "'");
        
        // 2. ç§»é™¤å®Œæ•´çš„HTMLç»“æ„æ ‡ç­¾
        cleanHtml = cleanHtml.replace(/<!DOCTYPE html>/gi, '');
        cleanHtml = cleanHtml.replace(/<html[^>]*>/gi, '');
        cleanHtml = cleanHtml.replace(/<head[^>]*>.*?<\/head>/gis, '');
        cleanHtml = cleanHtml.replace(/<body[^>]*>/gi, '');
        cleanHtml = cleanHtml.replace(/<\/body>/gi, '');
        cleanHtml = cleanHtml.replace(/<\/html>/gi, '');
        
        // 3. ç§»é™¤å¯èƒ½å½±å“å¸ƒå±€çš„è„šæœ¬å’Œæ ·å¼
        cleanHtml = cleanHtml.replace(/<script[^>]*>.*?<\/script>/gis, '');
        cleanHtml = cleanHtml.replace(/<style[^>]*>.*?<\/style>/gis, '');
        
        // 4. ä¸ºæ‰€æœ‰æ ‡ç­¾æ·»åŠ å†…è”æ ·å¼ï¼Œç¡®ä¿åœ¨æ·±è‰²/æµ…è‰²ä¸»é¢˜ä¸‹æ­£ç¡®æ˜¾ç¤º
        cleanHtml = cleanHtml.replace(/<h2([^>]*)>/gi, '<h2$1 style="color: var(--blue-400); margin: 1.5rem 0 1rem 0;">');
        cleanHtml = cleanHtml.replace(/<h3([^>]*)>/gi, '<h3$1 style="color: var(--blue-400); margin: 1rem 0 0.5rem 0;">');
        cleanHtml = cleanHtml.replace(/<p([^>]*)>/gi, '<p$1 style="margin: 0.5rem 0; line-height: 1.6;">');
        cleanHtml = cleanHtml.replace(/<table([^>]*)>/gi, '<table$1 style="width: 100%; border-collapse: collapse; margin: 1rem 0;">');
        cleanHtml = cleanHtml.replace(/<th([^>]*)>/gi, '<th$1 style="border: 1px solid var(--border-color); padding: 8px; text-align: left; background: var(--hover-bg); color: var(--gray-400);">');
        cleanHtml = cleanHtml.replace(/<td([^>]*)>/gi, '<td$1 style="border: 1px solid var(--border-color); padding: 8px; text-align: left;">');
        cleanHtml = cleanHtml.replace(/<strong([^>]*)>/gi, '<strong$1 style="color: var(--blue-400);">');
        
        // 5. æ¸…ç†å¤šä½™çš„ç©ºç™½å’Œç‰¹æ®Šå­—ç¬¦
        cleanHtml = cleanHtml.trim();
        
        // è¿”å›å¤„ç†åçš„HTMLï¼Œåœ¨å¼€å¤´æ·»åŠ å…è´£å£°æ˜
        return disclaimer + cleanHtml;
    }

    function processTextOutput(text) {
        // è¿™ä¸ªå‡½æ•°ä¿ç•™ç”¨äºå…¼å®¹æ€§ï¼Œç°åœ¨ä¸»è¦ä½¿ç”¨processFullContent
        return processFullContent(text);
    }

    function renderMarketTable(data) {
        console.log('renderMarketTableè¢«è°ƒç”¨ï¼Œæ•°æ®:', data);
        // ä¿å­˜å½“å‰æ˜¾ç¤ºçš„æ•°æ®
        currentDisplayedMarketData = data;
        
        // æ£€æŸ¥æ•°æ®ç±»å‹
        if (typeof data !== 'object' || data === null) {
            console.error('æ•°æ®ç±»å‹é”™è¯¯:', data);
            fullDataTable.innerHTML = `<div class="text-red-500">æ•°æ®ç±»å‹é”™è¯¯</div>`;
            return;
        }
        
        // æ£€æŸ¥æ˜¯å¦åŒ…å«stockDataå’ŒindexDataï¼ˆå¯èƒ½æ˜¯ç›´æ¥ä¼ é€’äº†æ•´ä¸ªæ•°æ®å¯¹è±¡ï¼‰
        let stockData = data;
        let sectorData = null;
        let moneyFlowData = null;
        let technicalIndicators = null;
        
        console.log('renderMarketTableæ•°æ®:', data);
        
        if (data.stockData && typeof data.stockData === 'object') {
            console.log('æ£€æµ‹åˆ°åŒ…å«stockDataçš„å¯¹è±¡');
            stockData = data.stockData;
        }
        
        // æå–æ–°å¢çš„æ•°æ®
        if (stockData['æ¿å—ä¿¡æ¯']) {
            sectorData = stockData['æ¿å—ä¿¡æ¯'];
        }
        if (stockData['èµ„é‡‘æµå‘']) {
            moneyFlowData = stockData['èµ„é‡‘æµå‘'];
        } else if (data['èµ„é‡‘æµå‘']) {
            // ç›´æ¥ä»dataä¸­æå–ï¼Œç”¨äºå†å²è®°å½•æŸ¥çœ‹
            moneyFlowData = data['èµ„é‡‘æµå‘'];
        }
        if (stockData['æŠ€æœ¯æŒ‡æ ‡']) {
            technicalIndicators = stockData['æŠ€æœ¯æŒ‡æ ‡'];
        } else if (data['æŠ€æœ¯æŒ‡æ ‡']) {
            // ç›´æ¥ä»dataä¸­æå–ï¼Œç”¨äºå†å²è®°å½•æŸ¥çœ‹
            technicalIndicators = data['æŠ€æœ¯æŒ‡æ ‡'];
        }
        
        // ç¡®ä¿technicalIndicatorsæ˜¯å¯¹è±¡
        if (!technicalIndicators || typeof technicalIndicators !== 'object') {
            technicalIndicators = {};
        }
        // æå–æ¸¯è‚¡ä¿¡æ¯
        let hkData = null;
        if (stockData['æ¸¯è‚¡ä¿¡æ¯']) {
            hkData = stockData['æ¸¯è‚¡ä¿¡æ¯'];
        } else if (data['hkData']) {
            // ç›´æ¥ä»dataä¸­æå–ï¼Œç”¨äºå†å²è®°å½•æŸ¥çœ‹
            hkData = data['hkData'];
        }
        
        console.log('æå–çš„æ•°æ®:', { sectorData, moneyFlowData, technicalIndicators });
        
        let html = '';
        
        // 1. åŸºç¡€è¡Œæƒ…æ•°æ®
        html += `<div class="mb-6">
            <h4 class="text-lg font-bold mb-3 text-gray-700 dark:text-gray-300">ğŸ“Š åŸºç¡€è¡Œæƒ…</h4>
            <div class="market-grid">`;
        
        // è¿‡æ»¤æ‰æ¿å—ä¿¡æ¯ã€èµ„é‡‘æµå‘ã€æŠ€æœ¯æŒ‡æ ‡ã€æ¸¯è‚¡ä¿¡æ¯è¿™äº›å¯¹è±¡ç±»å‹çš„é”®
        const basicKeys = Object.keys(stockData).filter(k => 
            typeof stockData[k] !== null && typeof stockData[k] !== undefined && 
            !['æ¿å—ä¿¡æ¯', 'èµ„é‡‘æµå‘', 'æŠ€æœ¯æŒ‡æ ‡', 'æ¸¯è‚¡ä¿¡æ¯'].includes(k)
        );
        
        basicKeys.forEach(k => {
            const val = stockData[k];
            if (typeof val === 'object') return; // è·³è¿‡å¯¹è±¡ç±»å‹
            let colorClass = '';
            if (k.includes('æ¶¨è·Œå¹…') || k.includes('æ¶¨è·Œ') || k.includes('æ¶¨å¹…')) {
                const numVal = parseFloat(val);
                if (numVal > 0) {
                    colorClass = 'positive';
                } else if (numVal < 0) {
                    colorClass = 'negative';
                }
            }
            
            html += `
                <div class="market-item">
                    <div class="market-label">${k}</div>
                    <div class="market-value ${colorClass}">${val}</div>
                </div>
            `;
        });
        
        html += `</div></div>`;
        
        // 2. æ¿å—ä¿¡æ¯
        if (sectorData && Object.keys(sectorData).length > 0) {
            html += `<div class="mb-6">
                <h4 class="text-lg font-bold mb-3 text-gray-700 dark:text-gray-300">ğŸ­ æ‰€å±æ¿å—</h4>
                <div class="market-grid">`;
            Object.keys(sectorData).forEach(k => {
                const val = sectorData[k];
                html += `
                    <div class="market-item">
                        <div class="market-label">${k}</div>
                        <div class="market-value">${val || '-'}</div>
                    </div>
                `;
            });
            html += `</div></div>`;
        }
        
        // 3. èµ„é‡‘æµå‘
        if (moneyFlowData && Object.keys(moneyFlowData).length > 0) {
            html += `<div class="mb-6">
                <h4 class="text-lg font-bold mb-3 text-gray-700 dark:text-gray-300">ğŸ’° èµ„é‡‘æµå‘</h4>
                
                <!-- èµ„é‡‘æµå‘è¡¨æ ¼ -->
                <div class="card p-4 mb-4">
                    <h5 class="text-md font-bold mb-3 text-gray-600 dark:text-gray-400">èµ„é‡‘æµå‘è¯¦ç»†æ•°æ®</h5>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead>
                                <tr class="border-b border-border-color">
                                    <th class="text-left p-2 text-gray-400">ç±»å‹</th>
                                    <th class="text-right p-2 text-gray-400">å‡€æµå…¥(ä¸‡å…ƒ)</th>
                                    <th class="text-right p-2 text-gray-400">æµå…¥(ä¸‡å…ƒ)</th>
                                    <th class="text-right p-2 text-gray-400">æµå‡º(ä¸‡å…ƒ)</th>
                                    <th class="text-right p-2 text-gray-400">å‡€å æ¯”</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr class="border-b border-border-color hover:bg-hover-bg">
                                    <td class="p-2 font-medium">è¶…å¤§å•</td>
                                    <td class="p-2 text-right">
                                        <span class="${parseFloat(moneyFlowData['è¶…å¤§å•å‡€æµå…¥'] || 0) > 0 ? 'text-red-500' : 'text-green-500'}">
                                            ${moneyFlowData['è¶…å¤§å•å‡€æµå…¥'] || '-'}
                                        </span>
                                    </td>
                                    <td class="p-2 text-right text-red-500">${moneyFlowData['è¶…å¤§å•æµå…¥'] || '-'}</td>
                                    <td class="p-2 text-right text-green-500">${moneyFlowData['è¶…å¤§å•æµå‡º'] || '-'}</td>
                                    <td class="p-2 text-right">${moneyFlowData['è¶…å¤§å•å‡€å æ¯”'] || '-'}</td>
                                </tr>
                                <tr class="border-b border-border-color hover:bg-hover-bg">
                                    <td class="p-2 font-medium">å¤§å•</td>
                                    <td class="p-2 text-right">
                                        <span class="${parseFloat(moneyFlowData['å¤§å•å‡€æµå…¥'] || 0) > 0 ? 'text-red-500' : 'text-green-500'}">
                                            ${moneyFlowData['å¤§å•å‡€æµå…¥'] || '-'}
                                        </span>
                                    </td>
                                    <td class="p-2 text-right text-red-500">${moneyFlowData['å¤§å•æµå…¥'] || '-'}</td>
                                    <td class="p-2 text-right text-green-500">${moneyFlowData['å¤§å•æµå‡º'] || '-'}</td>
                                    <td class="p-2 text-right">${moneyFlowData['å¤§å•å‡€å æ¯”'] || '-'}</td>
                                </tr>
                                <tr class="border-b border-border-color hover:bg-hover-bg">
                                    <td class="p-2 font-medium">ä¸­å•</td>
                                    <td class="p-2 text-right">
                                        <span class="${parseFloat(moneyFlowData['ä¸­å•å‡€æµå…¥'] || 0) > 0 ? 'text-red-500' : 'text-green-500'}">
                                            ${moneyFlowData['ä¸­å•å‡€æµå…¥'] || '-'}
                                        </span>
                                    </td>
                                    <td class="p-2 text-right text-red-500">${moneyFlowData['ä¸­å•æµå…¥'] || '-'}</td>
                                    <td class="p-2 text-right text-green-500">${moneyFlowData['ä¸­å•æµå‡º'] || '-'}</td>
                                    <td class="p-2 text-right">${moneyFlowData['ä¸­å•å‡€å æ¯”'] || '-'}</td>
                                </tr>
                                <tr class="border-b border-border-color hover:bg-hover-bg">
                                    <td class="p-2 font-medium">å°å•</td>
                                    <td class="p-2 text-right">
                                        <span class="${parseFloat(moneyFlowData['å°å•å‡€æµå…¥'] || 0) > 0 ? 'text-red-500' : 'text-green-500'}">
                                            ${moneyFlowData['å°å•å‡€æµå…¥'] || '-'}
                                        </span>
                                    </td>
                                    <td class="p-2 text-right text-red-500">${moneyFlowData['å°å•æµå…¥'] || '-'}</td>
                                    <td class="p-2 text-right text-green-500">${moneyFlowData['å°å•æµå‡º'] || '-'}</td>
                                    <td class="p-2 text-right">${moneyFlowData['å°å•å‡€å æ¯”'] || '-'}</td>
                                </tr>
                                <tr class="bg-hover-bg font-bold">
                                    <td class="p-2">ä¸»åŠ›åˆè®¡</td>
                                    <td class="p-2 text-right">
                                        <span class="${parseFloat(moneyFlowData['ä¸»åŠ›å‡€æµå…¥'] || 0) > 0 ? 'text-red-500' : 'text-green-500'}">
                                            ${moneyFlowData['ä¸»åŠ›å‡€æµå…¥'] || '-'}
                                        </span>
                                    </td>
                                    <td class="p-2 text-right">-</td>
                                    <td class="p-2 text-right">-</td>
                                    <td class="p-2 text-right">${moneyFlowData['ä¸»åŠ›å‡€å æ¯”'] || '-'}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- èµ„é‡‘æµå‘å›¾è¡¨ -->
                <div class="space-y-4">
                    <div class="card p-4">
                        <h5 class="text-md font-bold mb-3 text-gray-600 dark:text-gray-400">èµ„é‡‘å‡€æµå…¥(ä¸‡å…ƒ)</h5>
                        <canvas id="moneyFlowNetChart" style="max-height: 300px;"></canvas>
                    </div>
                    <div class="card p-4">
                        <h5 class="text-md font-bold mb-3 text-gray-600 dark:text-gray-400">èµ„é‡‘æµå…¥æµå‡ºå¯¹æ¯”(ä¸‡å…ƒ)</h5>
                        <canvas id="moneyFlowCompareChart" style="max-height: 300px;"></canvas>
                    </div>
                </div></div>`;
        }
        
        // 4. æŠ€æœ¯æŒ‡æ ‡
        if (technicalIndicators && Object.keys(technicalIndicators).length > 0) {
            html += `<div class="mb-6">
                <h4 class="text-lg font-bold mb-3 text-gray-700 dark:text-gray-300">ğŸ“ˆ æŠ€æœ¯æŒ‡æ ‡</h4>
                
                <!-- æŠ€æœ¯æŒ‡æ ‡è¡¨æ ¼ -->
                <div class="card p-4 mb-4">
                    <h5 class="text-md font-bold mb-3 text-gray-600 dark:text-gray-400">æŠ€æœ¯æŒ‡æ ‡è¯¦ç»†æ•°æ®</h5>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead>
                                <tr class="border-b border-border-color">
                                    <th class="text-left p-2 text-gray-400">æŒ‡æ ‡åç§°</th>
                                    <th class="text-right p-2 text-gray-400">æ•°å€¼</th>
                                    <th class="text-left p-2 text-gray-400">çŠ¶æ€</th>
                                    <th class="text-left p-2 text-gray-400">è¯´æ˜</th>
                                </tr>
                            </thead>
                            <tbody>`;
            
            // å…ˆæ·»åŠ å¸ƒæ—å¸¦çš„æ•´ä½“ä»‹ç»
            const hasBollinger = Object.keys(technicalIndicators).some(k => k.includes('å¸ƒæ—å¸¦'));
            if (hasBollinger) {
                html += `
                    <tr class="border-b border-border-color bg-blue-50 dark:bg-blue-900/20">
                        <td class="p-2 font-medium text-blue-500">å¸ƒæ—å¸¦(å¸ƒæ—çº¿)</td>
                        <td class="p-2 text-right">-</td>
                        <td class="p-2">-</td>
                        <td class="p-2 text-xs text-gray-400">${indicatorDescriptions['å¸ƒæ—å¸¦']}</td>
                    </tr>
                `;
            }
            
            Object.keys(technicalIndicators).forEach(k => {
                // è·³è¿‡å†å²æ•°æ®å­—æ®µå’ŒKçº¿æ—¥æœŸï¼Œåªæ˜¾ç¤ºæœ€æ–°å€¼
                if (k === 'CCIå†å²' || k === 'MACDå†å²' || k === 'å¸ƒæ—å¸¦å†å²' || k === 'Kçº¿æ—¥æœŸ') {
                    return;
                }
                
                const val = technicalIndicators[k];
                let displayVal = val !== null && val !== undefined ? val : '-';
                let status = '-';
                let statusClass = '';
                let description = indicatorDescriptions[k] || '-';
                
                // RSIè¶…ä¹°è¶…å–æç¤º
                if (k === 'RSI14' && !isNaN(parseFloat(val))) {
                    const rsiVal = parseFloat(val);
                    if (rsiVal > 70) {
                        status = 'è¶…ä¹°';
                        statusClass = 'text-red-500';
                    } else if (rsiVal < 30) {
                        status = 'è¶…å–';
                        statusClass = 'text-green-500';
                    } else {
                        status = 'ä¸­æ€§';
                        statusClass = 'text-gray-400';
                    }
                }
                
                // KDJé‡‘å‰æ­»å‰æç¤ºï¼ˆç®€åŒ–åˆ¤æ–­ï¼‰
                if (k === 'K' || k === 'D' || k === 'J') {
                    status = '-';
                }
                
                // å¸ƒæ—å¸¦ä»·æ ¼ä½ç½®æç¤º
                if (k === 'ä»·æ ¼ä½ç½®' && !isNaN(parseFloat(val))) {
                    const posVal = parseFloat(val);
                    if (posVal > 80) {
                        status = 'æ¥è¿‘ä¸Šè½¨';
                        statusClass = 'text-red-500';
                    } else if (posVal < 20) {
                        status = 'æ¥è¿‘ä¸‹è½¨';
                        statusClass = 'text-green-500';
                    } else {
                        status = 'ä¸­è½¨é™„è¿‘';
                        statusClass = 'text-gray-400';
                    }
                }
                
                // CCIè¶…ä¹°è¶…å–æç¤º
                if (k === 'CCI' && !isNaN(parseFloat(val))) {
                    const cciVal = parseFloat(val);
                    if (cciVal > 100) {
                        status = 'è¶…ä¹°';
                        statusClass = 'text-red-500';
                    } else if (cciVal < -100) {
                        status = 'è¶…å–';
                        statusClass = 'text-green-500';
                    } else {
                        status = 'æ­£å¸¸';
                        statusClass = 'text-gray-400';
                    }
                }
                
                html += `
                    <tr class="border-b border-border-color hover:bg-hover-bg">
                        <td class="p-2 font-medium">${k}</td>
                        <td class="p-2 text-right ${statusClass}">${displayVal}</td>
                        <td class="p-2 ${statusClass}">${status}</td>
                        <td class="p-2 text-xs text-gray-400">${description}</td>
                    </tr>
                `;
            });
            
            html += `</tbody></table></div></div>
                
                <!-- æŠ€æœ¯æŒ‡æ ‡å›¾è¡¨ -->
                <div class="space-y-4">
                    <div class="card p-4">
                        <h5 class="text-md font-bold mb-3 text-gray-600 dark:text-gray-400">å‡çº¿ç³»ç»Ÿ</h5>
                        <canvas id="emaChart" style="max-height: 300px;"></canvas>
                    </div>
                    <div class="card p-4">
                        <h5 class="text-md font-bold mb-3 text-gray-600 dark:text-gray-400">RSI & KDJ</h5>
                        <canvas id="rsiKdjChart" style="max-height: 300px;"></canvas>
                    </div>
                    <div class="card p-4">
                        <h5 class="text-md font-bold mb-3 text-gray-600 dark:text-gray-400">MACDæŒ‡æ ‡</h5>
                        <canvas id="macdChart" style="max-height: 300px;"></canvas>
                    </div>
                    <div class="card p-4">
                        <h5 class="text-md font-bold mb-3 text-gray-600 dark:text-gray-400">å¸ƒæ—å¸¦</h5>
                        <canvas id="bollingerChart" style="max-height: 300px;"></canvas>
                    </div>
                    <div class="card p-4">
                        <h5 class="text-md font-bold mb-3 text-gray-600 dark:text-gray-400">CCIèµ°åŠ¿</h5>
                        <canvas id="cciChart" style="max-height: 300px;"></canvas>
                    </div>
                </div></div>`;
        }
        
        // 5. æ¸¯è‚¡ä¿¡æ¯ - åªåœ¨åç«¯åˆ†æï¼Œä¸æ˜¾ç¤ºåœ¨å‰ç«¯
        // if (hkData && Object.keys(hkData).length > 0) {
        //     html += `<div class="mb-6">
        //         <h4 class="text-lg font-bold mb-3 text-gray-700 dark:text-gray-300">ğŸ‡­ğŸ‡° æ¸¯è‚¡ä¿¡æ¯</h4>
        //         <div class="market-grid">`;
        //     
        //     Object.keys(hkData).forEach(k => {
        //         const val = hkData[k];
        //         if (typeof val === 'object') return; // è·³è¿‡å¯¹è±¡ç±»å‹
        //         let colorClass = '';
        //         if (k.includes('æ¶¨è·Œå¹…') || k.includes('æ¶¨è·Œ') || k.includes('æ¶¨å¹…')) {
        //             const numVal = parseFloat(val);
        //             if (numVal > 0) {
        //                 colorClass = 'positive';
        //             } else if (numVal < 0) {
        //                 colorClass = 'negative';
        //             }
        //         }
        //         
        //         html += `
        //             <div class="market-item">
        //                 <div class="market-label">${k}</div>
        //                 <div class="market-value ${colorClass}">${val}</div>
        //             </div>
        //         `;
        //     });
        //     
        //     html += `</div></div>`;
        // }
        
        console.log('ç”Ÿæˆçš„HTML:', html);
        fullDataTable.innerHTML = html;
        
        // ç¡®ä¿å›¾è¡¨å®ä¾‹å˜é‡è¢«æ­£ç¡®åˆå§‹åŒ–
        if (typeof window.chartInstances === 'undefined') {
            window.chartInstances = {};
        }
        
        // ä¿å­˜æ•°æ®åˆ°å˜é‡ï¼Œä»¥ä¾¿setTimeoutå›è°ƒä½¿ç”¨
        const chartMoneyFlowData = moneyFlowData;
        const chartTechnicalIndicators = technicalIndicators;
        
        // å»¶è¿Ÿæ‰§è¡Œå›¾è¡¨ç»˜åˆ¶ï¼Œç¡®ä¿DOMå…ƒç´ å·²ç»æ¸²æŸ“å®Œæˆ
        setTimeout(function(moneyFlowData, technicalIndicators) {
            console.log('å¼€å§‹ç»˜åˆ¶å›¾è¡¨...');
            console.log('å›¾è¡¨æ•°æ®:', { moneyFlowData, technicalIndicators });
            
            // ç»˜åˆ¶èµ„é‡‘æµå‘å›¾è¡¨
            if (moneyFlowData && Object.keys(moneyFlowData).length > 0) {
                const textColor = document.body.getAttribute('data-theme') === 'dark' ? '#c9d1d9' : '#1f2328';
                const gridColor = document.body.getAttribute('data-theme') === 'dark' ? '#30363d' : '#e5e7eb';
                
                // å›¾è¡¨1ï¼šèµ„é‡‘å‡€æµå…¥ï¼ˆæ¨ªå‘æŸ±çŠ¶å›¾ï¼‰
                const netCanvas = document.getElementById('moneyFlowNetChart');
                if (netCanvas) {
                    console.log('å‡†å¤‡ç»˜åˆ¶èµ„é‡‘å‡€æµå…¥å›¾è¡¨...');
                    const ctxNet = netCanvas.getContext('2d');
                    
                    const labels = ['è¶…å¤§å•', 'å¤§å•', 'ä¸­å•', 'å°å•', 'ä¸»åŠ›'];
                    const netInflowData = [];
                    const colors = [];
                    
                    labels.forEach(label => {
                        const key = label + 'å‡€æµå…¥';
                        const val = moneyFlowData[key];
                        const numVal = parseFloat(val) || 0;
                        netInflowData.push(numVal);
                        
                        // çº¢è‰²è¡¨ç¤ºå‡€æµå…¥(æ­£)ï¼Œç»¿è‰²è¡¨ç¤ºå‡€æµå‡º(è´Ÿ)
                        if (numVal > 0) {
                            colors.push('rgba(220, 38, 38, 0.9)');
                        } else if (numVal < 0) {
                            colors.push('rgba(34, 197, 94, 0.9)');
                        } else {
                            colors.push('rgba(156, 163, 175, 0.8)');
                        }
                    });
                    
                    // é”€æ¯æ—§å›¾è¡¨
                    if (window.chartInstances.moneyFlowNetChartInstance) {
                        window.chartInstances.moneyFlowNetChartInstance.destroy();
                    }
                    
                    // åˆ›å»ºæ–°å›¾è¡¨
                    try {
                        window.chartInstances.moneyFlowNetChartInstance = new Chart(ctxNet, {
                            type: 'bar',
                            data: {
                                labels: labels,
                                datasets: [{
                                    label: 'å‡€æµå…¥(ä¸‡å…ƒ)',
                                    data: netInflowData,
                                    backgroundColor: colors,
                                    borderColor: colors.map(c => c.replace('0.9', '1').replace('0.8', '1')),
                                    borderWidth: 1
                                }]
                            },
                            options: {
                                indexAxis: 'y',
                                responsive: true,
                                maintainAspectRatio: true,
                                plugins: {
                                    legend: { display: false },
                                    tooltip: {
                                        callbacks: {
                                            label: function(context) {
                                                return 'å‡€æµå…¥: ' + formatMoneyFlow(context.parsed.x);
                                            }
                                        }
                                    }
                                },
                                scales: {
                                    x: {
                                        ticks: {
                                            color: textColor,
                                            callback: function(value) {
                                                return value >= 10000 ? (value / 10000).toFixed(2) + 'äº¿' : value + 'ä¸‡';
                                            }
                                        },
                                        grid: { color: gridColor }
                                    },
                                    y: {
                                        ticks: { color: textColor },
                                        grid: { display: false }
                                    }
                                }
                            }
                        });
                        console.log('èµ„é‡‘å‡€æµå…¥å›¾è¡¨ç»˜åˆ¶æˆåŠŸ');
                    } catch (error) {
                        console.error('ç»˜åˆ¶èµ„é‡‘å‡€æµå…¥å›¾è¡¨å¤±è´¥:', error);
                    }
                }
                
                // å›¾è¡¨2ï¼šèµ„é‡‘æµå…¥æµå‡ºå¯¹æ¯”
                const compareCanvas = document.getElementById('moneyFlowCompareChart');
                if (compareCanvas) {
                    console.log('å‡†å¤‡ç»˜åˆ¶èµ„é‡‘æµå…¥æµå‡ºå¯¹æ¯”å›¾è¡¨...');
                    const ctxCompare = compareCanvas.getContext('2d');
                    
                    const labels = ['è¶…å¤§å•', 'å¤§å•', 'ä¸­å•', 'å°å•'];
                    const inflowData = [];
                    const outflowData = [];
                    
                    labels.forEach(label => {
                        const inflowKey = label + 'æµå…¥';
                        const outflowKey = label + 'æµå‡º';
                        const inflowVal = moneyFlowData[inflowKey];
                        const outflowVal = moneyFlowData[outflowKey];
                        const inflowNum = parseFloat(inflowVal) || 0;
                        const outflowNum = parseFloat(outflowVal) || 0;
                        
                        inflowData.push(inflowNum);
                        outflowData.push(outflowNum);
                    });
                    
                    // é”€æ¯æ—§å›¾è¡¨
                    if (window.chartInstances.moneyFlowCompareChartInstance) {
                        window.chartInstances.moneyFlowCompareChartInstance.destroy();
                    }
                    
                    // åˆ›å»ºæ–°å›¾è¡¨
                    try {
                        window.chartInstances.moneyFlowCompareChartInstance = new Chart(ctxCompare, {
                            type: 'bar',
                            data: {
                                labels: labels,
                                datasets: [
                                    {
                                        label: 'æµå…¥',
                                        data: inflowData,
                                        backgroundColor: 'rgba(220, 38, 38, 0.9)',
                                        borderColor: 'rgb(220, 38, 38)',
                                        borderWidth: 1
                                    },
                                    {
                                        label: 'æµå‡º',
                                        data: outflowData.map(v => -v),
                                        backgroundColor: 'rgba(34, 197, 94, 0.9)',
                                        borderColor: 'rgb(34, 197, 94)',
                                        borderWidth: 1
                                    }
                                ]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: true,
                                plugins: {
                                    legend: {
                                        display: true,
                                        position: 'top',
                                        labels: { color: textColor }
                                    },
                                    tooltip: {
                                        callbacks: {
                                            label: function(context) {
                                                const value = Math.abs(context.parsed.y);
                                                return context.dataset.label + ': ' + formatMoneyFlow(value);
                                            }
                                        }
                                    }
                                },
                                scales: {
                                    x: {
                                        ticks: { color: textColor },
                                        grid: { display: false }
                                    },
                                    y: {
                                        ticks: {
                                            color: textColor,
                                            callback: function(value) {
                                                const absVal = Math.abs(value);
                                                return absVal >= 10000 ? (absVal / 10000).toFixed(2) + 'äº¿' : absVal + 'ä¸‡';
                                            }
                                        },
                                        grid: { color: gridColor }
                                    }
                                }
                            }
                        });
                        console.log('èµ„é‡‘æµå…¥æµå‡ºå¯¹æ¯”å›¾è¡¨ç»˜åˆ¶æˆåŠŸ');
                    } catch (error) {
                        console.error('ç»˜åˆ¶èµ„é‡‘æµå…¥æµå‡ºå¯¹æ¯”å›¾è¡¨å¤±è´¥:', error);
                    }
                }
            } else {
                console.log('æ²¡æœ‰èµ„é‡‘æµå‘æ•°æ®ï¼Œè·³è¿‡ç»˜åˆ¶èµ„é‡‘æµå‘å›¾è¡¨');
            }
            
            // ç»˜åˆ¶æŠ€æœ¯æŒ‡æ ‡å›¾è¡¨
            if (technicalIndicators && Object.keys(technicalIndicators).length > 0) {
                const textColor = document.body.getAttribute('data-theme') === 'dark' ? '#c9d1d9' : '#1f2328';
                const gridColor = document.body.getAttribute('data-theme') === 'dark' ? '#30363d' : '#e5e7eb';
                
                // å›¾è¡¨1ï¼šå‡çº¿ç³»ç»Ÿ
                const emaCanvas = document.getElementById('emaChart');
                if (emaCanvas) {
                    console.log('å‡†å¤‡ç»˜åˆ¶å‡çº¿ç³»ç»Ÿå›¾è¡¨...');
                    const ctxEma = emaCanvas.getContext('2d');
                    
                    const emaData = {
                        labels: ['EMA5', 'EMA10', 'EMA20', 'EMA30', 'EMA60'],
                        datasets: [{
                            label: 'å‡çº¿å€¼',
                            data: [
                                parseFloat(technicalIndicators['EMA5']) || 0,
                                parseFloat(technicalIndicators['EMA10']) || 0,
                                parseFloat(technicalIndicators['EMA20']) || 0,
                                parseFloat(technicalIndicators['EMA30']) || 0,
                                parseFloat(technicalIndicators['EMA60']) || 0
                            ],
                            borderColor: 'rgba(59, 130, 246, 1)',
                            backgroundColor: 'rgba(59, 130, 246, 0.2)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4
                        }]
                    };
                    
                    // é”€æ¯æ—§å›¾è¡¨
                    if (window.chartInstances.emaChartInstance) {
                        window.chartInstances.emaChartInstance.destroy();
                    }
                    
                    // åˆ›å»ºæ–°å›¾è¡¨
                    try {
                        window.chartInstances.emaChartInstance = new Chart(ctxEma, {
                            type: 'line',
                            data: emaData,
                            options: {
                                responsive: true,
                                maintainAspectRatio: true,
                                plugins: {
                                    legend: { display: false },
                                    tooltip: {
                                        callbacks: {
                                            label: function(context) {
                                                return context.parsed.y.toFixed(2);
                                            }
                                        }
                                    }
                                },
                                scales: {
                                    x: {
                                        ticks: { color: textColor },
                                        grid: { color: gridColor }
                                    },
                                    y: {
                                        ticks: { color: textColor },
                                        grid: { color: gridColor }
                                    }
                                }
                            }
                        });
                        console.log('å‡çº¿ç³»ç»Ÿå›¾è¡¨ç»˜åˆ¶æˆåŠŸ');
                    } catch (error) {
                        console.error('ç»˜åˆ¶å‡çº¿ç³»ç»Ÿå›¾è¡¨å¤±è´¥:', error);
                    }
                }
                
                // å›¾è¡¨2ï¼šRSI & KDJ
                const rsiKdjCanvas = document.getElementById('rsiKdjChart');
                if (rsiKdjCanvas) {
                    console.log('å‡†å¤‡ç»˜åˆ¶RSI & KDJå›¾è¡¨...');
                    const ctxRsiKdj = rsiKdjCanvas.getContext('2d');
                    
                    const rsiKdjData = {
                        labels: ['RSI14', 'K', 'D', 'J'],
                        datasets: [{
                            label: 'æ•°å€¼',
                            data: [
                                parseFloat(technicalIndicators['RSI14']) || 0,
                                parseFloat(technicalIndicators['K']) || 0,
                                parseFloat(technicalIndicators['D']) || 0,
                                parseFloat(technicalIndicators['J']) || 0
                            ],
                            backgroundColor: [
                                'rgba(168, 85, 247, 0.8)',
                                'rgba(249, 115, 22, 0.8)',
                                'rgba(34, 197, 94, 0.8)',
                                'rgba(236, 72, 153, 0.8)'
                            ],
                            borderColor: [
                                'rgb(168, 85, 247)',
                                'rgb(249, 115, 22)',
                                'rgb(34, 197, 94)',
                                'rgb(236, 72, 153)'
                            ],
                            borderWidth: 1
                        }]
                    };
                    
                    // é”€æ¯æ—§å›¾è¡¨
                    if (window.chartInstances.rsiKdjChartInstance) {
                        window.chartInstances.rsiKdjChartInstance.destroy();
                    }
                    
                    // åˆ›å»ºæ–°å›¾è¡¨
                    try {
                        window.chartInstances.rsiKdjChartInstance = new Chart(ctxRsiKdj, {
                            type: 'bar',
                            data: rsiKdjData,
                            options: {
                                responsive: true,
                                maintainAspectRatio: true,
                                plugins: {
                                    legend: { display: false },
                                    tooltip: {
                                        callbacks: {
                                            label: function(context) {
                                                return context.parsed.y.toFixed(2);
                                            }
                                        }
                                    }
                                },
                                scales: {
                                    x: {
                                        ticks: { color: textColor },
                                        grid: { display: false }
                                    },
                                    y: {
                                        ticks: { color: textColor },
                                        grid: { color: gridColor }
                                    }
                                }
                            }
                        });
                        console.log('RSI & KDJå›¾è¡¨ç»˜åˆ¶æˆåŠŸ');
                    } catch (error) {
                        console.error('ç»˜åˆ¶RSI & KDJå›¾è¡¨å¤±è´¥:', error);
                    }
                }
                
                // ç”Ÿæˆè¿‡å»30å¤©çš„æ—¥æœŸæ ‡ç­¾
                function generateDateLabels(days) {
                    const labels = [];
                    const today = new Date();
                    for (let i = days - 1; i >= 0; i--) {
                        const date = new Date(today);
                        date.setDate(today.getDate() - i);
                        labels.push(date.getMonth() + 1 + '/' + date.getDate());
                    }
                    return labels;
                }
                
                // å›¾è¡¨3ï¼šMACDæŒ‡æ ‡
                const macdCanvas = document.getElementById('macdChart');
                if (macdCanvas) {
                    console.log('å‡†å¤‡ç»˜åˆ¶MACDæŒ‡æ ‡å›¾è¡¨...');
                    const ctxMacd = macdCanvas.getContext('2d');
                    
                    // è·å–MACDæ•°æ®
                    const macdDif = parseFloat(technicalIndicators['MACD_DIF']) || 0;
                    const macdDea = parseFloat(technicalIndicators['MACD_DEA']) || 0;
                    const macdBar = parseFloat(technicalIndicators['MACDæŸ±']) || 0;
                    const macdHistory = technicalIndicators['MACDå†å²'] || [];
                    const klineDates = technicalIndicators['Kçº¿æ—¥æœŸ'] || [];
                    
                    // å‡†å¤‡MACDæ•°æ®
                    let difData = [];
                    let deaData = [];
                    let macdBarData = [];
                    let macdBarColors = [];
                    let dateLabels = [];
                    
                    if (macdHistory.length > 0) {
                        // ä½¿ç”¨çœŸå®å†å²æ•°æ®
                        macdHistory.forEach((item, index) => {
                            difData.push(item.DIF);
                            deaData.push(item.DEA);
                            macdBarData.push(item.MACD);
                            macdBarColors.push(item.MACD >= 0 ? 'rgba(239, 68, 68, 0.8)' : 'rgba(34, 197, 94, 0.8)');
                            
                            // ä½¿ç”¨Kçº¿æ•°æ®ä¸­çš„å®é™…æ—¥æœŸ
                            if (klineDates.length > 0) {
                                // è®¡ç®—å¯¹åº”çš„Kçº¿æ—¥æœŸç´¢å¼•
                                const klineIndex = klineDates.length - macdHistory.length + index;
                                if (klineIndex >= 0 && klineIndex < klineDates.length) {
                                    const dateStr = klineDates[klineIndex];
                                    // è½¬æ¢æ—¥æœŸæ ¼å¼ä¸º MM/DD
                                    const parts = dateStr.split('-');
                                    if (parts.length === 3) {
                                        dateLabels.push(parts[1] + '/' + parts[2]);
                                    } else {
                                        dateLabels.push(dateStr);
                                    }
                                } else {
                                    //  fallbackåˆ°ç”Ÿæˆçš„æ—¥æœŸ
                                    const date = new Date();
                                    date.setDate(date.getDate() - (macdHistory.length - 1 - index));
                                    dateLabels.push((date.getMonth() + 1) + '/' + date.getDate());
                                }
                            } else {
                                //  fallbackåˆ°ç”Ÿæˆçš„æ—¥æœŸ
                                const date = new Date();
                                date.setDate(date.getDate() - (macdHistory.length - 1 - index));
                                dateLabels.push((date.getMonth() + 1) + '/' + date.getDate());
                            }
                        });
                    } else {
                        //  fallbackåˆ°æ¨¡æ‹Ÿæ•°æ®
                        dateLabels = generateDateLabels(30);
                        difData = Array(30).fill(0).map((_, i) => macdDif * (0.8 + Math.random() * 0.4));
                        deaData = Array(30).fill(0).map((_, i) => macdDea * (0.8 + Math.random() * 0.4));
                        macdBarData = Array(30).fill(0).map((_, i) => macdBar * (0.8 + Math.random() * 0.4));
                        macdBarColors = Array(30).fill(0).map((_, i) => (macdBar * (0.8 + Math.random() * 0.4)) >= 0 ? 'rgba(239, 68, 68, 0.8)' : 'rgba(34, 197, 94, 0.8)');
                    }
                    
                    // åˆ›å»ºMACDæ•°æ®ç»“æ„
                    const macdData = {
                        labels: dateLabels,
                        datasets: [
                            {
                                label: 'DIF',
                                data: difData,
                                borderColor: 'rgba(239, 68, 68, 1)',
                                backgroundColor: 'rgba(239, 68, 68, 0.1)',
                                borderWidth: 2,
                                fill: false,
                                pointRadius: 2
                            },
                            {
                                label: 'DEA',
                                data: deaData,
                                borderColor: 'rgba(59, 130, 246, 1)',
                                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                                borderWidth: 2,
                                fill: false,
                                pointRadius: 2
                            },
                            {
                                label: 'MACDæŸ±',
                                data: macdBarData,
                                type: 'bar',
                                backgroundColor: macdBarColors,
                                borderColor: macdBarColors.map(color => color.replace('0.8', '1')),
                                borderWidth: 1,
                                fill: true
                            }
                        ]
                    };
                    
                    // é”€æ¯æ—§å›¾è¡¨
                    if (window.chartInstances.macdChartInstance) {
                        window.chartInstances.macdChartInstance.destroy();
                    }
                    
                    // åˆ›å»ºæ–°å›¾è¡¨
                    try {
                        window.chartInstances.macdChartInstance = new Chart(ctxMacd, {
                            type: 'line',
                            data: macdData,
                            options: {
                                responsive: true,
                                maintainAspectRatio: true,
                                plugins: {
                                    legend: {
                                        display: true,
                                        position: 'top',
                                        labels: {
                                            color: textColor,
                                            font: {
                                                size: 12
                                            }
                                        }
                                    },
                                    tooltip: {
                                        callbacks: {
                                            label: function(context) {
                                                let label = context.dataset.label || '';
                                                if (label) {
                                                    label += ': ';
                                                }
                                                if (context.parsed.y !== null) {
                                                    label += context.parsed.y.toFixed(4);
                                                }
                                                return label;
                                            }
                                        }
                                    }
                                },
                                scales: {
                                    x: {
                                        display: true,
                                        grid: {
                                            display: true,
                                            color: gridColor
                                        },
                                        ticks: {
                                            color: textColor,
                                            font: {
                                                size: 10
                                            },
                                            maxRotation: 45,
                                            minRotation: 45
                                        }
                                    },
                                    y: {
                                        ticks: { color: textColor },
                                        grid: { color: gridColor }
                                    }
                                }
                            }
                        });
                        console.log('MACDæŒ‡æ ‡å›¾è¡¨ç»˜åˆ¶æˆåŠŸ');
                    } catch (error) {
                        console.error('ç»˜åˆ¶MACDæŒ‡æ ‡å›¾è¡¨å¤±è´¥:', error);
                    }
                }
                
                // å›¾è¡¨4ï¼šå¸ƒæ—å¸¦
                const bollingerCanvas = document.getElementById('bollingerChart');
                if (bollingerCanvas) {
                    console.log('å‡†å¤‡ç»˜åˆ¶å¸ƒæ—å¸¦å›¾è¡¨...');
                    const ctxBollinger = bollingerCanvas.getContext('2d');
                    
                    // è·å–å¸ƒæ—å¸¦æ•°æ®
                    const upperBand = parseFloat(technicalIndicators['å¸ƒæ—å¸¦ä¸Šè½¨']) || 0;
                    const middleBand = parseFloat(technicalIndicators['å¸ƒæ—å¸¦ä¸­è½¨']) || 0;
                    const lowerBand = parseFloat(technicalIndicators['å¸ƒæ—å¸¦ä¸‹è½¨']) || 0;
                    const pricePosition = parseFloat(technicalIndicators['ä»·æ ¼ä½ç½®']) || 0;
                    const klineDates = technicalIndicators['Kçº¿æ—¥æœŸ'] || [];
                    
                    // è®¡ç®—å½“å‰ä»·æ ¼ï¼ˆæ ¹æ®ä»·æ ¼ä½ç½®åœ¨ä¸Šä¸­ä¸‹è½¨ä¹‹é—´çš„ä½ç½®ï¼‰
                    const currentPrice = lowerBand + (upperBand - lowerBand) * (pricePosition / 100);
                    
                    // ç”Ÿæˆæ—¥æœŸæ ‡ç­¾
                    let dateLabels = [];
                    const days = Math.min(30, klineDates.length);
                    
                    if (klineDates.length > 0) {
                        // ä½¿ç”¨Kçº¿æ•°æ®ä¸­çš„å®é™…æ—¥æœŸ
                        const recentDates = klineDates.slice(-days);
                        recentDates.forEach(dateStr => {
                            // è½¬æ¢æ—¥æœŸæ ¼å¼ä¸º MM/DD
                            const parts = dateStr.split('-');
                            if (parts.length === 3) {
                                dateLabels.push(parts[1] + '/' + parts[2]);
                            } else {
                                dateLabels.push(dateStr);
                            }
                        });
                    } else {
                        //  fallbackåˆ°ç”Ÿæˆçš„æ—¥æœŸ
                        dateLabels = generateDateLabels(30);
                    }
                    
                    // åˆ›å»ºå¸ƒæ—å¸¦æ•°æ®ç»“æ„ï¼ˆä½¿ç”¨çœŸå®å†å²æ•°æ®ï¼‰
                    const bollingerHistory = technicalIndicators['å¸ƒæ—å¸¦å†å²'] || [];
                    let upperBandData = [];
                    let middleBandData = [];
                    let lowerBandData = [];
                    
                    if (bollingerHistory.length > 0) {
                        // ä½¿ç”¨çœŸå®å†å²æ•°æ®
                        bollingerHistory.forEach((item, index) => {
                            upperBandData.push(item.upper);
                            middleBandData.push(item.middle);
                            lowerBandData.push(item.lower);
                        });
                        
                        // è°ƒæ•´æ—¥æœŸæ ‡ç­¾ä»¥åŒ¹é…å†å²æ•°æ®é•¿åº¦
                        if (klineDates.length > 0) {
                            const days = Math.min(bollingerHistory.length, klineDates.length);
                            const recentDates = klineDates.slice(-days);
                            dateLabels = [];
                            recentDates.forEach(dateStr => {
                                const parts = dateStr.split('-');
                                if (parts.length === 3) {
                                    dateLabels.push(parts[1] + '/' + parts[2]);
                                } else {
                                    dateLabels.push(dateStr);
                                }
                            });
                        }
                    } else {
                        //  fallbackåˆ°æ¨¡æ‹Ÿæ•°æ®
                        upperBandData = Array(dateLabels.length).fill(0).map((_, i) => upperBand * (0.95 + Math.random() * 0.1));
                        middleBandData = Array(dateLabels.length).fill(0).map((_, i) => middleBand * (0.95 + Math.random() * 0.1));
                        lowerBandData = Array(dateLabels.length).fill(0).map((_, i) => lowerBand * (0.95 + Math.random() * 0.1));
                    }
                    
                    const bollingerData = {
                        labels: dateLabels,
                        datasets: [
                            {
                                label: 'ä¸Šè½¨',
                                data: upperBandData,
                                borderColor: 'rgba(245, 158, 11, 1)',
                                backgroundColor: 'rgba(245, 158, 11, 0.1)',
                                borderWidth: 2,
                                fill: false,
                                pointRadius: 2
                            },
                            {
                                label: 'ä¸­è½¨',
                                data: middleBandData,
                                borderColor: 'rgba(59, 130, 246, 1)',
                                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                                borderWidth: 2,
                                fill: false,
                                pointRadius: 2
                            },
                            {
                                label: 'ä¸‹è½¨',
                                data: lowerBandData,
                                borderColor: 'rgba(16, 185, 129, 1)',
                                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                                borderWidth: 2,
                                fill: false,
                                pointRadius: 2
                            },
                            {
                                label: 'ä»·æ ¼ä½ç½®',
                                data: Array(dateLabels.length - 1).fill(null).concat([currentPrice]),
                                borderColor: 'rgba(239, 68, 68, 1)',
                                backgroundColor: 'rgba(239, 68, 68, 0.2)',
                                borderWidth: 0,
                                fill: false,
                                pointRadius: 8,
                                pointHoverRadius: 10,
                                pointStyle: 'circle'
                            }
                        ]
                    };
                    
                    // é”€æ¯æ—§å›¾è¡¨
                    if (window.chartInstances.bollingerChartInstance) {
                        window.chartInstances.bollingerChartInstance.destroy();
                    }
                    
                    // åˆ›å»ºæ–°å›¾è¡¨
                    try {
                        window.chartInstances.bollingerChartInstance = new Chart(ctxBollinger, {
                            type: 'line',
                            data: bollingerData,
                            options: {
                                responsive: true,
                                maintainAspectRatio: true,
                                plugins: {
                                    legend: {
                                        display: true,
                                        position: 'top',
                                        labels: {
                                            color: textColor,
                                            font: {
                                                size: 12
                                            }
                                        }
                                    },
                                    tooltip: {
                                        callbacks: {
                                            label: function(context) {
                                                let label = context.dataset.label || '';
                                                if (label) {
                                                    label += ': ';
                                                }
                                                if (context.parsed.y !== null) {
                                                    label += context.parsed.y.toFixed(2);
                                                }
                                                return label;
                                            }
                                        }
                                    }
                                },
                                scales: {
                                    x: {
                                        display: true,
                                        grid: {
                                            display: true,
                                            color: gridColor
                                        },
                                        ticks: {
                                            color: textColor,
                                            font: {
                                                size: 10
                                            },
                                            maxRotation: 45,
                                            minRotation: 45
                                        }
                                    },
                                    y: {
                                        ticks: { color: textColor },
                                        grid: { color: gridColor }
                                    }
                                }
                            }
                        });
                        console.log('å¸ƒæ—å¸¦å›¾è¡¨ç»˜åˆ¶æˆåŠŸ');
                    } catch (error) {
                        console.error('ç»˜åˆ¶å¸ƒæ—å¸¦å›¾è¡¨å¤±è´¥:', error);
                    }
                }
                
                // å›¾è¡¨5ï¼šCCIèµ°åŠ¿
                const cciCanvas = document.getElementById('cciChart');
                if (cciCanvas) {
                    console.log('å‡†å¤‡ç»˜åˆ¶CCIèµ°åŠ¿å›¾è¡¨...');
                    const ctxCci = cciCanvas.getContext('2d');
                    
                    // è·å–CCIæ•°æ®
                    const cciValue = parseFloat(technicalIndicators['CCI']) || 0;
                    const cciHistory = technicalIndicators['CCIå†å²'] || [];
                    const klineDates = technicalIndicators['Kçº¿æ—¥æœŸ'] || [];
                    
                    // ç”Ÿæˆæ—¥æœŸæ ‡ç­¾
                    let dateLabels = [];
                    const days = Math.min(30, cciHistory.length > 0 ? cciHistory.length : klineDates.length);
                    
                    if (klineDates.length > 0) {
                        // ä½¿ç”¨Kçº¿æ•°æ®ä¸­çš„å®é™…æ—¥æœŸ
                        const recentDates = klineDates.slice(-days);
                        recentDates.forEach(dateStr => {
                            // è½¬æ¢æ—¥æœŸæ ¼å¼ä¸º MM/DD
                            const parts = dateStr.split('-');
                            if (parts.length === 3) {
                                dateLabels.push(parts[1] + '/' + parts[2]);
                            } else {
                                dateLabels.push(dateStr);
                            }
                        });
                    } else {
                        //  fallbackåˆ°ç”Ÿæˆçš„æ—¥æœŸ
                        dateLabels = generateDateLabels(30);
                    }
                    
                    // åˆ›å»ºCCIæ•°æ®ç»“æ„
                    const cciData = {
                        labels: dateLabels,
                        datasets: [
                            {
                                label: 'CCI',
                                data: cciHistory.length > 0 ? cciHistory.slice(-dateLabels.length) : Array(dateLabels.length).fill(0).map((_, i) => cciValue * (0.8 + Math.random() * 0.4)),
                                borderColor: 'rgba(245, 158, 11, 1)',
                                backgroundColor: 'rgba(245, 158, 11, 0.1)',
                                borderWidth: 2,
                                fill: false,
                                pointRadius: 2
                            }
                        ]
                    };
                    
                    // é”€æ¯æ—§å›¾è¡¨
                    if (window.chartInstances.cciChartInstance) {
                        window.chartInstances.cciChartInstance.destroy();
                    }
                    
                    // åˆ›å»ºæ–°å›¾è¡¨
                    try {
                        window.chartInstances.cciChartInstance = new Chart(ctxCci, {
                            type: 'line',
                            data: cciData,
                            options: {
                                responsive: true,
                                maintainAspectRatio: true,
                                plugins: {
                                    legend: {
                                        display: true,
                                        position: 'top',
                                        labels: {
                                            color: textColor,
                                            font: {
                                                size: 12
                                            }
                                        }
                                    },
                                    tooltip: {
                                        callbacks: {
                                            label: function(context) {
                                                let label = context.dataset.label || '';
                                                if (label) {
                                                    label += ': ';
                                                }
                                                if (context.parsed.y !== null) {
                                                    label += context.parsed.y.toFixed(2);
                                                }
                                                return label;
                                            }
                                        }
                                    }
                                },
                                scales: {
                                    x: {
                                        display: true,
                                        grid: {
                                            display: true,
                                            color: gridColor
                                        },
                                        ticks: {
                                            color: textColor,
                                            font: {
                                                size: 10
                                            },
                                            maxRotation: 45,
                                            minRotation: 45
                                        }
                                    },
                                    y: {
                                        ticks: { color: textColor },
                                        grid: { color: gridColor },
                                        suggestedMin: -200,
                                        suggestedMax: 200
                                    }
                                }
                            }
                        });
                        console.log('CCIèµ°åŠ¿å›¾è¡¨ç»˜åˆ¶æˆåŠŸ');
                    } catch (error) {
                        console.error('ç»˜åˆ¶CCIèµ°åŠ¿å›¾è¡¨å¤±è´¥:', error);
                    }
                }
            } else {
                console.log('æ²¡æœ‰æŠ€æœ¯æŒ‡æ ‡æ•°æ®ï¼Œè·³è¿‡ç»˜åˆ¶æŠ€æœ¯æŒ‡æ ‡å›¾è¡¨');
            }
            console.log('æ‰€æœ‰å›¾è¡¨ç»˜åˆ¶å®Œæˆ');
        }, 200, chartMoneyFlowData, chartTechnicalIndicators);
    }

    // å¤ç›˜æ•°æ®åŠŸèƒ½
    let reviewRecordCount = 0;
    
    // æ·»åŠ å¤ç›˜è®°å½•
    document.getElementById('addReviewBtn').addEventListener('click', function() {
        reviewRecordCount++;
        
        const reviewRecord = document.createElement('div');
        reviewRecord.className = 'review-record flex gap-2 items-center border border-border-color rounded p-3 bg-hover-bg';
        reviewRecord.dataset.id = reviewRecordCount;
        
        reviewRecord.innerHTML = `
            <select name="review_type_${reviewRecordCount}" class="w-1/6 bg-input-bg border border-border-color rounded p-2 outline-none">
                <option value="buy">ä¹°å…¥</option>
                <option value="sell">å–å‡º</option>
            </select>
            <input type="number" step="0.01" name="review_price_${reviewRecordCount}" placeholder="ä»·æ ¼" class="w-1/6 bg-input-bg border border-border-color rounded p-2 outline-none">
            <input type="number" name="review_amount_${reviewRecordCount}" placeholder="æ•°é‡" class="w-1/6 bg-input-bg border border-border-color rounded p-2 outline-none">
            <input type="time" name="review_time_${reviewRecordCount}" class="w-1/6 bg-input-bg border border-border-color rounded p-2 outline-none" title="ç‚¹å‡»é€‰æ‹©æ—¶é—´">
            <input type="number" name="review_remaining_${reviewRecordCount}" placeholder="å‰©ä½™æ•°é‡" class="w-1/6 bg-input-bg border border-border-color rounded p-2 outline-none">
            <button type="button" class="remove-review-btn text-red-400 hover:text-red-300" data-id="${reviewRecordCount}">åˆ é™¤</button>
        `;
        
        document.getElementById('reviewDataContainer').appendChild(reviewRecord);
        document.getElementById('emptyReviewHint').classList.add('hidden');
        
        // ç¦ç”¨æ—¶é—´è¾“å…¥çš„é¼ æ ‡æ»šè½®äº‹ä»¶
        const timeInput = reviewRecord.querySelector(`input[name^="review_time_"]`);
        timeInput.addEventListener('wheel', function(e) {
            e.preventDefault();
        }, { passive: false });
        
        // æ·»åŠ åˆ é™¤äº‹ä»¶
        reviewRecord.querySelector('.remove-review-btn').addEventListener('click', function() {
            const id = this.dataset.id;
            const record = document.querySelector(`.review-record[data-id="${id}"]`);
            if (record) {
                record.remove();
            }
            
            // æ£€æŸ¥æ˜¯å¦è¿˜æœ‰è®°å½•
            if (document.querySelectorAll('.review-record').length === 0) {
                document.getElementById('emptyReviewHint').classList.remove('hidden');
            }
        });
    });

    // è‚¡ç¥¨åç§°æœç´¢åŠŸèƒ½
    searchBtn.addEventListener('click', async () => {
        const stockName = stockNameInput.value.trim();
        if (!stockName) {
                alert('è¯·è¾“å…¥è‚¡ç¥¨/åŸºé‡‘åç§°');
                return;
            }
        
        searchBtn.disabled = true;
        searchBtn.innerText = 'æœç´¢ä¸­...';
        searchResults.innerHTML = '<div class="text-blue-400 animate-pulse">æ­£åœ¨æœç´¢è‚¡ç¥¨/åŸºé‡‘...</div>';
        searchResults.classList.remove('hidden');
        
        try {
            // è°ƒç”¨åç«¯çœŸå®çš„è‚¡ç¥¨æœç´¢API
            const response = await fetch(`backend.php?action=search_stock&name=${encodeURIComponent(stockName)}`);
            
            if (!response.ok) {
                throw new Error('ç½‘ç»œè¯·æ±‚å¤±è´¥: ' + response.status);
            }
            
            // å…ˆè·å–æ–‡æœ¬å†…å®¹ï¼Œä¾¿äºè°ƒè¯•
            const text = await response.text();
            console.log('åç«¯è¿”å›æ•°æ®:', text);
            
            // å°è¯•è§£æJSON
            const data = JSON.parse(text);
            
            if (data.error) {
                throw new Error(data.error);
            }
            
            const matchedStocks = data.stocks || [];
            
            if (matchedStocks.length === 0) {
                searchResults.innerHTML = '<div class="text-gray-400">æœªæ‰¾åˆ°åŒ¹é…çš„è‚¡ç¥¨</div>';
            } else {
                let resultsHtml = '';
                matchedStocks.forEach(stock => {
                    resultsHtml += `
                        <div class="flex justify-between items-center p-2 hover:bg-hover-bg rounded cursor-pointer stock-item" data-code="${stock.code}" data-market="${stock.market}">
                            <div>
                                <div class="font-medium">${stock.name}</div>
                                <div class="text-xs text-gray-400">${stock.fullCode}</div>
                            </div>
                            <button class="text-blue-400 text-sm select-stock">é€‰æ‹©</button>
                        </div>
                    `;
                });
                searchResults.innerHTML = resultsHtml;
                
                // æ·»åŠ é€‰æ‹©æŒ‰é’®äº‹ä»¶
                document.querySelectorAll('.select-stock').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const stockItem = this.closest('.stock-item');
                        const code = stockItem.dataset.code;
                        const market = stockItem.dataset.market;
                        const fullCode = `${market}${code}`;
                        const stockName = stockItem.querySelector('.font-medium').textContent;
                        
                        // å¡«å……è‚¡ç¥¨ä»£ç è¾“å…¥æ¡†
                        symbolInput.value = code;
                        
                        // æ˜¾ç¤ºç¡®è®¤ä¿¡æ¯
                        searchResults.innerHTML = `<div class="text-green-400">å·²é€‰æ‹©: ${stockName} (${fullCode})</div>`;
                        
                        // 3ç§’åéšè—ç»“æœ
                        setTimeout(() => {
                            searchResults.classList.add('hidden');
                        }, 3000);
                    });
                });
            }
        } catch (error) {
            searchResults.innerHTML = `<div class="text-red-400">æœç´¢å¤±è´¥: ${error.message}</div>`;
        } finally {
            searchBtn.disabled = false;
            searchBtn.innerText = 'æœç´¢';
        }
    });

    // ç‚¹å‡»å¤–éƒ¨å…³é—­æœç´¢ç»“æœ
    document.addEventListener('click', (e) => {
        if (!searchBtn.contains(e.target) && !stockNameInput.contains(e.target) && !searchResults.contains(e.target)) {
            searchResults.classList.add('hidden');
        }
    });
    
    // ä¸»é¢˜åˆ‡æ¢åŠŸèƒ½
    const themeToggle = document.getElementById('themeToggle');
    const body = document.body;
    
    // ä¿å­˜å½“å‰æ˜¾ç¤ºçš„å¸‚åœºæ•°æ®ï¼Œç”¨äºä¸»é¢˜åˆ‡æ¢æ—¶é‡æ–°æ¸²æŸ“
    let currentDisplayedMarketData = null;
    
    // åŠ è½½ä¿å­˜çš„ä¸»é¢˜
    function loadTheme() {
        const savedTheme = getStorage('theme');
        if (savedTheme) {
            setTheme(savedTheme);
        }
    }
    
    // è®¾ç½®ä¸»é¢˜
    function setTheme(theme) {
        body.setAttribute('data-theme', theme);
        setStorage('theme', theme, 365);
        
        // æ›´æ–°ä¸»é¢˜åˆ‡æ¢æŒ‰é’®
        if (theme === 'dark') {
            document.querySelector('.dark-icon').classList.remove('hidden');
            document.querySelector('.light-icon').classList.add('hidden');
            document.querySelector('.dark-text').classList.remove('hidden');
            document.querySelector('.light-text').classList.add('hidden');
        } else {
            document.querySelector('.dark-icon').classList.add('hidden');
            document.querySelector('.light-icon').classList.remove('hidden');
            document.querySelector('.dark-text').classList.add('hidden');
            document.querySelector('.light-text').classList.remove('hidden');
        }
        
        // æ›´æ–°CSSå˜é‡
        updateCSSVariables(theme);
        
        // å¦‚æœæœ‰æ˜¾ç¤ºçš„å¸‚åœºæ•°æ®ï¼Œé‡æ–°æ¸²æŸ“ä»¥æ›´æ–°å›¾è¡¨é¢œè‰²
        if (currentDisplayedMarketData && !marketCard.classList.contains('hidden')) {
            renderMarketTable(currentDisplayedMarketData);
        }
    }
    
    // æ›´æ–°CSSå˜é‡
    function updateCSSVariables(theme) {
        console.log('æ›´æ–°CSSå˜é‡ï¼Œä¸»é¢˜:', theme);
        if (theme === 'dark') {
            document.documentElement.style.setProperty('--bg-color', '#0d1117');
            document.documentElement.style.setProperty('--text-color', '#c9d1d9');
            document.documentElement.style.setProperty('--card-bg', '#161b22');
            document.documentElement.style.setProperty('--border-color', '#30363d');
            document.documentElement.style.setProperty('--input-bg', '#0d1117');
            document.documentElement.style.setProperty('--hover-bg', '#21262d');
            document.documentElement.style.setProperty('--gray-400', '#8b949e');
            document.documentElement.style.setProperty('--gray-500', '#6e7681');
        } else {
            document.documentElement.style.setProperty('--bg-color', '#ffffff');
            document.documentElement.style.setProperty('--text-color', '#333333');
            document.documentElement.style.setProperty('--card-bg', '#f8f9fa');
            document.documentElement.style.setProperty('--border-color', '#dee2e6');
            document.documentElement.style.setProperty('--input-bg', '#ffffff');
            document.documentElement.style.setProperty('--hover-bg', '#e9ecef');
            document.documentElement.style.setProperty('--gray-400', '#6c757d');
            document.documentElement.style.setProperty('--gray-500', '#adb5bd');
        }
        console.log('CSSå˜é‡æ›´æ–°å®Œæˆ');
    }
    
    // åˆ‡æ¢ä¸»é¢˜
    themeToggle.addEventListener('click', function() {
        console.log('ç‚¹å‡»ä¸»é¢˜åˆ‡æ¢æŒ‰é’®');
        const currentTheme = body.getAttribute('data-theme');
        console.log('å½“å‰ä¸»é¢˜:', currentTheme);
        const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
        console.log('åˆ‡æ¢åˆ°ä¸»é¢˜:', newTheme);
        setTheme(newTheme);
    });
</script>
</body>
</html>